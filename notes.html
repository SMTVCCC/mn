<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Minimal Notes (Demo)</title>

<!-- Marked for Markdown rendering + DOMPurify for sanitizing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<!-- CryptoJS for Spark API authentication -->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>

<!-- Flaticon for icons -->
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-thin-rounded/css/uicons-thin-rounded.css'>
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-solid-rounded/css/uicons-solid-rounded.css'>
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-straight/css/uicons-regular-straight.css'>
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-bold-straight/css/uicons-bold-straight.css'>

<style>
  /* 全局重置，确保全屏容器无页面留白 */
  html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
  }
  /* 基本重置 */
  * { box-sizing: border-box; }
  html,body { height:100%; margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #f2f4f7; -webkit-font-smoothing:antialiased; }

  /* 字体加粗模式 */
  .bold-font-mode {
    font-weight: 550 !important;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
  }
  
  .bold-font-mode .app-title,
  .bold-font-mode .setting-label span,
  .bold-font-mode .note-title,
  .bold-font-mode .action-btn,
  .bold-font-mode .login-label,
  .bold-font-mode .stats-title,
  .bold-font-mode .storage-title,
  .bold-font-mode .upgrade-title h3 {
    font-weight: 650 !important;
  }
  
  .bold-font-mode .setting-description,
  .bold-font-mode .note-content,
  .bold-font-mode .login-input,
  .bold-font-mode .stat-label,
  .bold-font-mode .feature-text,
  .bold-font-mode .storage-details,
  .bold-font-mode #noteBody,
  .bold-font-mode .editor-unified textarea {
    font-weight: 500 !important;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
  }

  /* 字体加大模式 */
  .font-size-mode {
    font-size: 110% !important;
  }
  
  .font-size-mode #noteBody,
  .font-size-mode .editor-unified textarea {
    font-size: 18px !important;
  }

  /* 模拟小窗口容器（适合直接在浏览器查看，也适合放到 Electron） */
  .app-root {
    width: 100vw; height: 100vh;
    margin: 0;
    border-radius: 0;
    overflow: hidden;
    display: flex;
    border: none;
    background: linear-gradient(180deg, rgba(255,255,255,0.72), rgba(250,250,250,0.72));
    box-shadow: none;
    backdrop-filter: blur(10px) saturate(120%);
    position: relative;
  }

  /* 标题栏（frameless 风格） */
  .titlebar {
    height: 52px;
    display:flex;
    align-items:center;
    padding: 0 14px;
    border-bottom: 1px solid rgba(0,0,0,0.04);
    background: linear-gradient(180deg, rgba(255,255,255,0.5), rgba(255,255,255,0.35));
    gap:12px;
    flex-shrink:0;
  }
  .win-controls { display:flex; gap:8px; align-items:center; }
  .dot { width:12px; height:12px; border-radius:50%; display:inline-block; opacity:0; }
  .dot.red{ background:#ff5f57; }
  .dot.yellow{ background:#ffbd2e; }
  .dot.green{ background:#28c840; }

  .app-title { font-weight:600; font-size:16px; color:#111; margin-left:6px; }
  .title-spacer{ flex:1; }

  .title-actions { display:flex; gap:8px; align-items:center; }
  .action-btn {
    border: none;
    background: transparent;
    padding:10px;
    border-radius:8px;
    cursor:pointer;
    font-size:14px;
    color:#3b3b3b;
  }
  .action-btn svg { /* 调整SVG图标大小 */
    width: 1.35em;
    height: 1.35em;
    vertical-align: middle;
    transform: translateY(1px);
  }
  .action-btn:hover { background: rgba(10,132,255,0.06); color:#0A84FF; }
  
  /* AI按钮禁用状态样式 */
  .action-btn.ai-disabled {
    opacity: 0.4 !important;
    cursor: not-allowed !important;
    background: rgba(128, 128, 128, 0.1) !important;
    color: #999 !important;
    pointer-events: none;
  }
  
  .action-btn.ai-disabled:hover {
    background: rgba(128, 128, 128, 0.1) !important;
    color: #999 !important;
  }
  
  .ai-submit-btn.ai-disabled {
    opacity: 0.4 !important;
    cursor: not-allowed !important;
    background: rgba(128, 128, 128, 0.1) !important;
    color: #999 !important;
    pointer-events: none;
  }
  
  /* 删除按钮和设置按钮的图标大小 */
  #deleteBtn, #settingsBtn, #profileBtn {
    font-size: 17px;
  }
  #deleteBtn i, #settingsBtn i, #profileBtn i {
    font-size: 17px;
  }

  /* 自动补全开关按钮样式 */
  #autoCompleteToggleBtn[data-enabled="false"] {
    opacity: 0.5;
  }
  #autoCompleteToggleBtn[data-enabled="true"] {
    background: rgba(10,132,255,0.1);
    color: #0A84FF;
  }
  #autoCompleteToggleBtn[data-enabled="true"] svg rect:first-of-type {
    fill: #0A84FF;
  }

  /* 主体布局 */
  .container { display:flex; flex:1; min-height:0; } /* min-height:0 防止 flex overflow */
  .sidebar {
    width: 300px;
    border-right: 1px solid rgba(0,0,0,0.04);
    padding: 12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(245,245,246,0.6));
    display:flex;
    flex-direction:column;
    gap:8px;
    transition: width 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
    overflow: hidden;
  }

  /* AI助手输入框样式 */
  .ai-input-container {
    background: rgba(10,132,255,0.04);
    padding: 15px;
    border-bottom: 1px solid rgba(0,0,0,0.04);
    border-radius: 12px;
    margin-bottom: 12px;
    animation: slideDown 0.3s ease-out;
  }

  .ai-input-wrapper {
    display: flex;
    gap: 10px;
    align-items: center;
    background: rgba(255,255,255,0.9);
    padding: 10px;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,0.04);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  #aiCustomInput {
    flex: 1;
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 14px;
    outline: none;
    background: rgba(255,255,255,0.8);
  }

  #aiCustomInput:focus {
    border-color: #0A84FF;
    box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.15);
  }

  .ai-submit-btn, .ai-cancel-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .ai-submit-btn {
    background: #0A84FF;
    color: white;
  }

  .ai-submit-btn:hover {
    background: #0056b3;
    transform: translateY(-1px);
  }

  .ai-cancel-btn {
    background: rgba(0,0,0,0.04);
    color: #666;
  }

  .ai-cancel-btn:hover {
    background: rgba(0,0,0,0.08);
    color: #333;
  }

  /* 登录/注册标签样式 */
  .auth-tabs {
    display: flex;
    border-bottom: 1px solid rgba(0,0,0,0.06);
    margin-bottom: 24px;
    background: rgba(250,250,250,0.5);
    border-radius: 12px 12px 0 0;
    padding: 4px;
  }

  .auth-tab {
    flex: 1;
    padding: 12px 16px;
    border: none;
    background: transparent;
    color: #666;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 8px;
    position: relative;
  }

  .auth-tab.active {
    color: #4da6ff;
    background: rgba(77, 166, 255, 0.08);
    box-shadow: 0 1px 3px rgba(77, 166, 255, 0.2);
  }

  .auth-tab:hover {
    color: #4da6ff;
    background: rgba(77, 166, 255, 0.04);
    transform: translateY(-1px);
  }

  /* 登录表单切换 */
  .login-form {
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .login-form.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
  }

  /* 登录页面动画 */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* 禁用按钮样式 */
  .social-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  /* 个人资料下拉菜单样式 */
  .profile-container {
    position: relative;
    display: inline-block;
  }

  .profile-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #e5e5e7;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    min-width: 200px;
    z-index: 1001;
    margin-top: 8px;
    animation: slideDown 0.2s ease-out;
  }

  .profile-info {
    padding: 16px;
    border-bottom: 1px solid #f0f0f0;
  }

  .profile-name {
    font-weight: 600;
    font-size: 14px;
    color: #111;
    margin-bottom: 4px;
  }

  .profile-email {
    font-size: 12px;
    color: #666;
  }

  .profile-divider {
    height: 1px;
    background: #f0f0f0;
    margin: 8px 0;
  }

  .profile-menu-item {
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: none;
    text-align: left;
    font-size: 14px;
    color: #111;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .profile-menu-item:hover {
    background: rgba(10, 132, 255, 0.04);
  }

  .profile-menu-item:active {
    background: rgba(10, 132, 255, 0.08);
  }

  @keyframes slideDown {
     from {
       opacity: 0;
       transform: translateY(-10px);
     }
     to {
       opacity: 1;
       transform: translateY(0);
     }
   }

   /* 个人资料页面样式 */
   .profile-section {
     padding: 20px;
     max-width: 900px;
     margin: 0 auto;
   }

   /* 2x2网格布局 */
   .profile-layout {
     display: grid;
     grid-template-columns: 1fr 1fr;
     gap: 20px;
   }

   .profile-left,
   .profile-right {
     display: contents;
   }

   /* 个人信息卡片 */
   .profile-card {
     background: rgba(255, 255, 255, 0.9);
     border-radius: 20px;
     padding: 24px;
     border: 1px solid rgba(0, 0, 0, 0.06);
     backdrop-filter: blur(10px);
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
     display: flex;
     align-items: center;
     gap: 16px;
   }

   .profile-card .profile-avatar {
     width: 64px;
     height: 64px;
     border-radius: 50%;
     /* 移除背景和边框 */
     background: none;
     border: none;
     display: flex;
     align-items: center;
     justify-content: center;
     color: white;
     flex-shrink: 0;
     position: relative;
     overflow: hidden;
     /* 移除动画 */
     transition: none;
   }

   .profile-card .profile-avatar:hover {
     /* 移除动画 */
     transform: none;
     box-shadow: none;
   }

   .profile-card .profile-avatar::before {
     /* 移除动画 */
     display: none;
   }

   .profile-card .profile-avatar:hover::before {
     /* 移除动画 */
     opacity: 0;
   }

   @keyframes shimmer {
     0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
     50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
     100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
   }

   .profile-card .profile-info {
     flex: 1;
   }

   .profile-card .profile-name {
     font-size: 18px;
     font-weight: 600;
     color: #333333;
     margin: 0 0 4px 0;
   }

   .profile-card .profile-email {
     font-size: 14px;
     color: #666666;
     margin: 0 0 4px 0;
   }

   .profile-card .profile-date {
     font-size: 12px;
     color: #999999;
     margin: 0 0 8px 0;
   }

   .profile-card .profile-badge {
     display: inline-block;
   }

   .badge-expiry {
     font-size: 12px;
     color: #999999;
     margin-left: 8px;
   }

   .profile-card .badge-text {
     background: rgba(255, 255, 255, 0.25);
     backdrop-filter: blur(20px);
     -webkit-backdrop-filter: blur(20px);
     color: #4da6ff;
     padding: 8px 16px;
     border-radius: 12px;
     font-size: 12px;
     font-weight: 600;
     border: 1px solid rgba(77, 166, 255, 0.5); /* 添加蓝色外框 */
     box-shadow: 
       0 8px 32px rgba(0, 0, 0, 0.1),
       inset 0 1px 0 rgba(255, 255, 255, 0.4),
       inset 0 -1px 0 rgba(0, 0, 0, 0.05);
     position: relative;
     overflow: hidden;
     /* 移除动画 */
   }

   /* 会员徽章颜色：Plus绿色、Pro紫色 */
   .profile-card .badge-text.badge-plus {
     color: #22c55e;
     border-color: rgba(34, 197, 94, 0.5);
   }
   .profile-card .badge-text.badge-pro {
     color: #8b5cf6;
     border-color: rgba(139, 92, 246, 0.5);
   }
   
   .profile-card .badge-text:hover {
     /* 移除动画效果，保留玻璃质感 */
     transform: none;
     box-shadow: 
       0 8px 32px rgba(0, 0, 0, 0.1),
       inset 0 1px 0 rgba(255, 255, 255, 0.4),
       inset 0 -1px 0 rgba(0, 0, 0, 0.05);
     background: rgba(255, 255, 255, 0.25);
     border-color: rgba(77, 166, 255, 0.5);
   }
   
   .profile-card .badge-text:hover::before {
     /* 移除动画 */
     left: -100%;
   }
   
   .profile-card .badge-text:active {
     /* 移除动画效果，保留玻璃质感 */
     transform: none;
     transition: none;
   }

   /* 统计信息卡片 */
   .stats-card {
     background: rgba(255, 255, 255, 0.9);
     border-radius: 20px;
     padding: 24px;
     border: 1px solid rgba(0, 0, 0, 0.06);
     backdrop-filter: blur(10px);
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
   }

   .stats-title {
     font-size: 16px;
     font-weight: 600;
     color: #333333;
     margin: 0 0 16px 0;
   }

   .stats-grid {
     display: grid;
     grid-template-columns: 1fr 1fr;
     gap: 16px;
   }

   .stats-grid {
     display: grid;
     grid-template-columns: 1fr 1fr;
     gap: 16px;
   }

   .stats-card .stat-item {
     text-align: center;
     padding: 12px;
     border-radius: 12px;
     background: rgba(77, 166, 255, 0.05);
     transition: all 0.3s ease;
   }

   .stats-card .stat-item:hover {
     background: rgba(77, 166, 255, 0.1);
     transform: translateY(-2px);
     box-shadow: 0 6px 24px rgba(77, 166, 255, 0.2);
   }

   .stats-card .stat-number {
     font-size: 20px;
     font-weight: 700;
     color: #4da6ff;
     margin-bottom: 4px;
     transition: all 0.3s ease;
   }

   .stats-card .stat-item:hover .stat-number {
     background: linear-gradient(135deg, #4da6ff, #3399ff);
     -webkit-background-clip: text;
     -webkit-text-fill-color: transparent;
     background-clip: text;
     transform: scale(1.1);
   }

   .stats-card .stat-label {
     font-size: 12px;
     color: #666666;
     font-weight: 500;
   }

   /* 账户操作区域 */
   .account-actions {
     margin-top: 20px;
     padding-top: 16px;
     border-top: 1px solid rgba(0, 0, 0, 0.08);
     display: flex;
     flex-direction: column;
     gap: 8px;
   }

   .account-action-btn {
     display: flex;
     align-items: center;
     gap: 8px;
     padding: 10px 12px;
     border: none;
     border-radius: 8px;
     font-size: 13px;
     font-weight: 500;
     cursor: pointer;
     transition: all 0.3s ease;
     background: rgba(0, 0, 0, 0.04);
     color: #666666;
   }

   .account-action-btn:hover {
     background: rgba(0, 0, 0, 0.08);
     color: #333333;
     transform: translateX(2px);
   }

   .account-action-btn.logout-btn:hover {
     background: rgba(255, 59, 48, 0.1);
     color: #ff3b30;
   }

   .account-action-btn.forgot-btn:hover {
     background: rgba(77, 166, 255, 0.1);
     color: #4da6ff;
   }

   .account-action-btn.cloud-upload-btn:hover {
     background: rgba(77, 166, 255, 0.1);
     color: #4da6ff;
   }

   .account-action-btn svg {
     width: 16px;
     height: 16px;
     flex-shrink: 0;
   }

   /* 存储卡片 */
   .storage-card {
     background: rgba(255, 255, 255, 0.9);
     border-radius: 20px;
     padding: 24px;
     border: 1px solid rgba(0, 0, 0, 0.06);
     backdrop-filter: blur(10px);
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
   }

   .storage-card .storage-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 16px;
   }

   .storage-card .storage-title {
     font-size: 16px;
     font-weight: 600;
     color: #333333;
     margin: 0;
   }

   .storage-card .storage-percentage {
     font-size: 14px;
     font-weight: 600;
     color: #4da6ff;
   }

   .storage-visual {
     margin-bottom: 12px;
   }

   .storage-card .storage-bar {
     height: 8px;
     background: rgba(0, 0, 0, 0.06);
     border-radius: 4px;
     overflow: hidden;
     margin-bottom: 8px;
   }

   .storage-card .storage-fill {
     height: 100%;
     background: linear-gradient(90deg, #4da6ff, #3399ff);
     border-radius: 4px;
     transition: width 0.3s ease;
   }

   .storage-card .storage-details {
     font-size: 12px;
     color: #666666;
     text-align: center;
   }

   .storage-tips {
     margin-top: 12px;
     padding: 0;
   }

   .expand-storage-btn {
     width: 100%;
     display: flex;
     align-items: center;
     justify-content: space-between;
     padding: 10px 14px;
     background: transparent;
     border: 1px solid #4da6ff;
     border-radius: 8px;
     color: #4da6ff;
     font-size: 13px;
     font-weight: 500;
     cursor: pointer;
     transition: all 0.3s ease;
     box-shadow: none;
     position: relative;
     overflow: hidden;
   }

   .expand-storage-btn:hover {
     transform: translateY(-1px);
     background: rgba(77, 166, 255, 0.1);
     box-shadow: 0 3px 12px rgba(77, 166, 255, 0.2);
   }

   .expand-storage-btn:active {
     transform: translateY(0);
     transition: all 0.1s ease;
   }

   .expand-storage-btn .btn-icon {
     width: 16px;
     height: 16px;
     margin-right: 8px;
     position: relative;
     z-index: 1;
   }

   .expand-storage-btn .btn-text {
     flex: 1;
     text-align: left;
     position: relative;
     z-index: 1;
   }

   .expand-storage-btn .btn-arrow {
     width: 14px;
     height: 14px;
     opacity: 0.8;
     transition: transform 0.3s ease;
     position: relative;
     z-index: 1;
   }

   .expand-storage-btn:hover .btn-arrow {
     transform: translateX(2px);
     opacity: 1;
   }

   /* 升级卡片 */
   .upgrade-card {
     background: rgba(255, 255, 255, 0.9);
     border-radius: 20px;
     padding: 24px;
     border: 1px solid rgba(0, 0, 0, 0.06);
     backdrop-filter: blur(10px);
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
   }

   .upgrade-header {
     display: flex;
     align-items: center;
     gap: 12px;
     margin-bottom: 16px;
   }

   .upgrade-card .upgrade-icon {
     width: 60px; /* 增大图标尺寸 */
     height: 60px; /* 增大图标尺寸 */
     border-radius: 50%;
     background: none; /* 删除蓝色背景 */
     display: flex;
     align-items: center;
     justify-content: center;
     color: #4da6ff;
   }

   .upgrade-card .upgrade-icon .upgrade-svg-icon {
     width: 100%;
     height: 100%;
   }

   .upgrade-title h3 {
     font-size: 16px;
     font-weight: 600;
     color: #333333;
     margin: 0 0 2px 0;
   }

   .upgrade-title p {
     font-size: 12px;
     color: #666666;
     margin: 0;
   }

   .upgrade-features {
     margin-bottom: 16px;
   }

   .feature-item {
     display: flex;
     align-items: center;
     gap: 8px;
     padding: 6px 0;
   }

   .feature-icon {
     font-size: 14px;
     width: 20px;
     text-align: center;
   }

   .feature-text {
     font-size: 13px;
     color: #666666;
   }

   .upgrade-card .upgrade-button {
     width: 100%;
     background: linear-gradient(135deg, #4da6ff, #3399ff);
     color: white;
     border: none;
     padding: 12px 20px;
     border-radius: 12px;
     font-size: 14px;
     font-weight: 600;
     cursor: pointer;
     transition: all 0.2s ease;
   }

   .upgrade-card .upgrade-button:hover {
     background: linear-gradient(135deg, #3399ff, #2d8cff);
     transform: translateY(-1px);
     box-shadow: 0 6px 20px rgba(77, 166, 255, 0.3);
   }

   /* 响应式设计 */
   @media (max-width: 1024px) and (min-width: 769px) {
     /* 平板端适配 */
     .profile-layout {
       gap: 18px;
     }
     
     .profile-card,
     .stats-card,
     .storage-card,
     .upgrade-card {
       padding: 20px;
     }
   }

   @media (max-width: 768px) and (min-width: 481px) {
     /* 小平板端适配 */
     .profile-layout {
       grid-template-columns: 1fr 1fr;
       grid-template-rows: auto auto;
       gap: 16px;
     }

     .profile-card,
     .stats-card,
     .storage-card,
     .upgrade-card {
       padding: 18px;
     }

     .profile-card .profile-avatar {
       width: 56px;
       height: 56px;
     }
   }

   @media (max-width: 480px) {
     /* 移动端适配 */
     .profile-layout {
       grid-template-columns: 1fr;
       grid-template-rows: repeat(4, auto);
       gap: 16px;
     }

     .profile-card,
     .stats-card,
     .storage-card,
     .upgrade-card {
       padding: 16px;
     }

     .profile-card .profile-avatar {
       width: 48px;
       height: 48px;
     }

     .stats-grid {
       grid-template-columns: 1fr;
       gap: 12px;
     }

     .upgrade-header {
       flex-direction: column;
       text-align: center;
       gap: 8px;
     }

     .feature-item {
       justify-content: center;
     }
   }

   @media (max-width: 480px) {
     /* 小屏移动端优化 */
     .profile-section {
       padding: 16px;
       max-width: 100%;
     }

     .profile-layout {
       gap: 12px;
     }

     .profile-card,
     .stats-card,
     .storage-card,
     .upgrade-card {
       padding: 16px;
       border-radius: 16px;
     }

     .profile-card .profile-name {
       font-size: 16px;
     }

     .stats-title {
       font-size: 15px;
     }

     .stats-card .stat-number {
       font-size: 18px;
     }

     .stats-card .stat-item {
       padding: 16px 12px;
       min-height: 60px;
     }

     .storage-card .storage-title {
       font-size: 15px;
     }

     .upgrade-title h3 {
       font-size: 15px;
     }

     .upgrade-card .upgrade-button {
       padding: 16px 20px;
       font-size: 15px;
       min-height: 48px;
     }
   }

   /* 个人信息头部 */
   .profile-header {
     background: rgba(255, 255, 255, 0.95);
     border-radius: 16px;
     padding: 24px;
     border: 1px solid rgba(0,0,0,0.04);
     backdrop-filter: blur(20px);
     display: flex;
     align-items: center;
     gap: 16px;
     position: relative;
     overflow: hidden;
   }

   .profile-header::before {
     content: '';
     position: absolute;
     top: 0;
     left: 0;
     right: 0;
     height: 1px;
     background: linear-gradient(90deg, transparent, rgba(77, 166, 255, 0.2), transparent);
   }

   .profile-avatar {
     width: 64px;
     height: 64px;
     border-radius: 50%;
     background: linear-gradient(135deg, rgba(77, 166, 255, 0.08), rgba(51, 153, 255, 0.04));
     display: flex;
     align-items: center;
     justify-content: center;
     color: #4da6ff;
     flex-shrink: 0;
     border: 1px solid rgba(77, 166, 255, 0.1);
   }

   .profile-avatar svg {
     width: 28px;
     height: 28px;
   }

   .profile-info {
     flex: 1;
     position: relative;
   }

   .profile-name {
     font-size: 26px;
     font-weight: 600;
     color: #1d1d1f;
     margin: 0 0 10px 0;
     line-height: 1.3;
     letter-spacing: -0.3px;
   }

   .profile-email {
     font-size: 16px;
     color: #86868b;
     margin: 0 0 6px 0;
     line-height: 1.5;
     font-weight: 400;
     transition: color 0.2s ease;
   }

   .profile-email:hover {
     color: #5a5a5f;
   }

   .profile-date {
     font-size: 14px;
     color: #a1a1a6;
     margin: 0;
     line-height: 1.4;
     font-weight: 400;
   }

   .profile-stats {
     display: flex;
     gap: 40px;
     margin-bottom: 32px;
     padding: 24px 36px;
     background: rgba(250,250,250,0.5);
     border-radius: 16px;
     border: 1px solid rgba(0,0,0,0.04);
     backdrop-filter: blur(10px);
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
   }

   .profile-stats:hover {
     background: rgba(250,250,250,0.8);
     border-color: rgba(0,0,0,0.08);
     transform: translateY(-1px);
   }

   .stat-item {
     text-align: center;
     flex: 1;
     position: relative;
   }

   .stat-item:not(:last-child)::after {
     content: '';
     position: absolute;
     right: -20px;
     top: 50%;
     transform: translateY(-50%);
     width: 1px;
     height: 24px;
     background: #e5e5e7;
   }

   .stat-value {
     font-size: 32px;
     font-weight: 600;
     color: #1d1d1f;
     margin-bottom: 6px;
     line-height: 1;
     background: linear-gradient(135deg, #1d1d1f, #3a3a3c);
     -webkit-background-clip: text;
     -webkit-text-fill-color: transparent;
     background-clip: text;
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
     cursor: pointer;
   }

   .stat-value:hover {
     transform: scale(1.05);
     background: linear-gradient(135deg, #4da6ff, #3399ff);
     -webkit-background-clip: text;
     -webkit-text-fill-color: transparent;
     background-clip: text;
   }

   .stat-label {
     font-size: 13px;
     color: #86868b;
     font-weight: 500;
     letter-spacing: 0.3px;
     text-transform: uppercase;
   }

   /* 云盘使用情况样式 */
   .storage-section {
     background: rgba(250,250,250,0.5);
     border-radius: 16px;
     border: 1px solid rgba(0,0,0,0.04);
     backdrop-filter: blur(10px);
     padding: 28px 36px;
     margin-bottom: 32px;
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
   }

   .storage-section:hover {
     background: rgba(250,250,250,0.8);
     border-color: rgba(0,0,0,0.08);
     transform: translateY(-1px);
   }

   .storage-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 20px;
   }

   .storage-title {
     font-size: 18px;
     font-weight: 600;
     color: #1d1d1f;
     margin: 0;
   }

   .storage-info {
     font-size: 14px;
     color: #86868b;
     font-weight: 500;
   }

   .storage-progress {
     margin-top: 16px;
   }

   .storage-progress-bar {
     width: 100%;
     height: 8px;
     background: rgba(0,0,0,0.08);
     border-radius: 4px;
     overflow: hidden;
     position: relative;
   }

   .storage-progress-fill {
     height: 100%;
     background: linear-gradient(90deg, #4da6ff, #3399ff);
     border-radius: 4px;
     transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
     position: relative;
     overflow: hidden;
   }

   .storage-progress-fill::after {
     content: '';
     position: absolute;
     top: 0;
     left: -100%;
     width: 100%;
     height: 100%;
     background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
     animation: shimmer 2s infinite;
   }

   .storage-available {
     margin-top: 12px;
     text-align: center;
     font-size: 13px;
     color: #86868b;
     font-weight: 500;
   }

   /* 不同使用级别的颜色 */
   .storage-progress-fill.low {
     background: linear-gradient(90deg, #66BB6A, #4CAF50);
   }

   .storage-progress-fill.medium {
     background: linear-gradient(90deg, #FFA726, #FB8C00);
   }

   .storage-progress-fill.high {
     background: linear-gradient(90deg, #FF6B6B, #F44336);
   }

   .profile-actions {
     display: flex;
     gap: 16px;
     padding: 0 36px;
     justify-content: center;
   }

   .profile-action-btn {
     padding: 14px 28px;
     border: none;
     border-radius: 12px;
     font-size: 15px;
     font-weight: 500;
     cursor: pointer;
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
     display: flex;
     align-items: center;
     gap: 8px;
     min-width: 160px;
     justify-content: center;
     position: relative;
     overflow: hidden;
   }

   .profile-action-btn::before {
     content: '';
     position: absolute;
     top: 0;
     left: -100%;
     width: 100%;
     height: 100%;
     background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
     transition: left 0.6s ease;
   }

   .profile-action-btn:hover::before {
     left: 100%;
   }

   .profile-action-btn svg {
     width: 18px;
     height: 18px;
     transition: transform 0.2s ease;
   }

   .profile-action-btn:hover svg {
     transform: translateX(-2px);
   }

   .profile-action-btn.primary {
     background: linear-gradient(135deg, #4da6ff, #3399ff);
     color: white;
     box-shadow: 0 4px 16px rgba(77, 166, 255, 0.25);
   }

   .profile-action-btn.primary:hover {
     background: linear-gradient(135deg, #3399ff, #1a8cff);
     transform: translateY(-2px);
     box-shadow: 0 6px 20px rgba(77, 166, 255, 0.35);
   }

   .profile-action-btn.primary:active {
     transform: translateY(0);
     box-shadow: 0 2px 8px rgba(77, 166, 255, 0.25);
   }

   .profile-action-btn.primary:hover {
     background: linear-gradient(135deg, #0051D5, #004bb8);
     box-shadow: 0 6px 24px rgba(0, 122, 255, 0.35);
     transform: translateY(-1px);
   }

   .profile-action-btn.secondary {
     background: rgba(250,250,250,0.8);
     color: #4da6ff;
     border: 1px solid rgba(77, 166, 255, 0.3);
     box-shadow: 0 2px 8px rgba(77, 166, 255, 0.1);
     backdrop-filter: blur(10px);
   }

   .profile-action-btn.secondary:hover {
     background: rgba(77, 166, 255, 0.1);
     color: #4da6ff;
     border-color: rgba(77, 166, 255, 0.5);
     box-shadow: 0 4px 16px rgba(77, 166, 255, 0.2);
     transform: translateY(-2px);
   }

   .profile-action-btn.secondary:active {
     transform: translateY(0);
     box-shadow: 0 2px 8px rgba(77, 166, 255, 0.1);
   }

   .profile-action-btn:active {
     transform: translateY(0);
     transition: transform 0.1s ease;
   }

   /* 按钮波纹效果 */
   .profile-action-btn::after {
     content: '';
     position: absolute;
     top: 50%;
     left: 50%;
     width: 0;
     height: 0;
     border-radius: 50%;
     background: rgba(255, 255, 255, 0.3);
     transform: translate(-50%, -50%);
     transition: width 0.3s ease, height 0.3s ease;
   }

   .profile-action-btn:active::after {
     width: 300px;
     height: 300px;
   }

   /* 微交互动画 */
   @keyframes fadeInUp {
     from {
       opacity: 0;
       transform: translateY(20px);
     }
     to {
       opacity: 1;
       transform: translateY(0);
     }
   }

   @keyframes scaleIn {
     from {
       opacity: 0;
       transform: scale(0.9);
     }
     to {
       opacity: 1;
       transform: scale(1);
     }
   }

   .profile-card {
     animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
   }

   .profile-stats {
     animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.1s both;
   }

   /* 新设计样式 */
   .profile-badge {
     background: rgba(77, 166, 255, 0.1);
     color: #4da6ff;
     padding: 6px 12px;
     border-radius: 12px;
     font-size: 12px;
     font-weight: 500;
     border: 1px solid rgba(77, 166, 255, 0.2);
   }

   .quick-stats {
     background: rgba(255, 255, 255, 0.95);
     border-radius: 16px;
     padding: 20px;
     border: 1px solid rgba(0,0,0,0.04);
     backdrop-filter: blur(20px);
     display: flex;
     align-items: center;
     justify-content: space-between;
   }

   .stat-item {
     text-align: center;
     flex: 1;
   }

   .stat-number {
     font-size: 18px;
     font-weight: 600;
     color: #1a1a1a;
     margin-bottom: 4px;
   }

   .stat-label {
     font-size: 12px;
     color: #666;
     font-weight: 400;
   }

   .stat-divider {
     width: 1px;
     height: 32px;
     background: rgba(0,0,0,0.08);
     margin: 0 16px;
   }

   .storage-overview {
     background: rgba(255, 255, 255, 0.95);
     border-radius: 16px;
     padding: 20px;
     border: 1px solid rgba(0,0,0,0.04);
     backdrop-filter: blur(20px);
   }

   .storage-overview .storage-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 12px;
   }

   .storage-overview .storage-title {
     font-size: 14px;
     font-weight: 500;
     color: #1a1a1a;
   }

   .storage-overview .storage-percentage {
     font-size: 14px;
     font-weight: 600;
     color: #4da6ff;
   }

   .storage-bar {
     height: 6px;
     background: rgba(0,0,0,0.06);
     border-radius: 3px;
     overflow: hidden;
     margin-bottom: 8px;
   }

   .storage-fill {
     height: 100%;
     background: linear-gradient(90deg, #4da6ff, #3399ff);
     border-radius: 3px;
     transition: width 0.3s ease;
   }

   .storage-details {
     font-size: 12px;
     color: #666;
     text-align: center;
   }

   .upgrade-recommendation {
     background: linear-gradient(135deg, rgba(77, 166, 255, 0.05), rgba(51, 153, 255, 0.02));
     border-radius: 16px;
     padding: 20px;
     border: 1px solid rgba(77, 166, 255, 0.1);
     backdrop-filter: blur(20px);
     display: flex;
     align-items: center;
     justify-content: space-between;
   }

   .upgrade-content {
     display: flex;
     align-items: center;
     gap: 12px;
     flex: 1;
   }

   .upgrade-icon {
     width: 36px;
     height: 36px;
     border-radius: 50%;
     background: rgba(77, 166, 255, 0.1);
     display: flex;
     align-items: center;
     justify-content: center;
     color: #4da6ff;
   }

   .upgrade-text h3 {
     font-size: 14px;
     font-weight: 600;
     color: #1a1a1a;
     margin: 0 0 2px 0;
   }

   .upgrade-text p {
     font-size: 12px;
     color: #666;
     margin: 0;
   }

   .upgrade-button {
     background: linear-gradient(135deg, #4da6ff, #3399ff);
     color: white;
     border: none;
     padding: 8px 16px;
     border-radius: 12px;
     font-size: 12px;
     font-weight: 500;
     cursor: pointer;
     transition: all 0.2s ease;
   }

   .upgrade-button:hover {
     background: linear-gradient(135deg, #3399ff, #2d8cff);
     transform: translateY(-1px);
     box-shadow: 0 4px 12px rgba(77, 166, 255, 0.3);
   }

   /* 动画效果 */
   .profile-header {
     animation: slideInDown 0.6s cubic-bezier(0.4, 0, 0.2, 1);
   }

   .quick-stats {
     animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.1s both;
   }

   .storage-overview {
     animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
   }

   .upgrade-recommendation {
     animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.3s both;
   }

   .stat-item {
     transition: transform 0.2s ease;
   }

   .stat-item:hover {
     transform: translateY(-2px);
   }

   .stat-number {
     transition: color 0.2s ease;
   }

   .stat-item:hover .stat-number {
     color: #4da6ff;
   }

   @keyframes slideInDown {
     from {
       opacity: 0;
       transform: translateY(-20px);
     }
     to {
       opacity: 1;
       transform: translateY(0);
     }
   }

   @keyframes slideInUp {
     from {
       opacity: 0;
       transform: translateY(20px);
     }
     to {
       opacity: 1;
       transform: translateY(0);
     }
   }

   /* 响应式设计 */
   @media (max-width: 768px) {
     .profile-section {
       padding: 16px;
       gap: 16px;
     }

     .profile-header {
       padding: 16px;
     }

     .quick-stats {
       padding: 16px;
       flex-direction: column;
       gap: 16px;
     }

     .stat-divider {
       width: 100%;
       height: 1px;
       margin: 0;
     }

     .storage-overview {
       padding: 16px;
     }

     .upgrade-recommendation {
       padding: 16px;
       flex-direction: column;
       gap: 12px;
       text-align: center;
     }

     .upgrade-content {
       justify-content: center;
     }
   }

   .profile-actions {
     animation: fadeInUp 0.7s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
   }

   /* 升级计划卡片样式 */
   .upgrade-plan-card {
     background: linear-gradient(135deg, rgba(77, 166, 255, 0.08) 0%, rgba(51, 153, 255, 0.05) 100%);
     backdrop-filter: blur(20px);
     border: 1px solid rgba(77, 166, 255, 0.2);
     border-radius: 20px;
     padding: 32px;
     margin-bottom: 24px;
     position: relative;
     overflow: hidden;
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
     animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.15s both;
   }

   .upgrade-plan-card::before {
     content: '';
     position: absolute;
     top: 0;
     left: 0;
     right: 0;
     height: 2px;
     background: linear-gradient(90deg, #4da6ff 0%, #3399ff 100%);
   }

   .upgrade-plan-card:hover {
     transform: translateY(-3px);
     border-color: rgba(77, 166, 255, 0.3);
     background: linear-gradient(135deg, rgba(77, 166, 255, 0.12) 0%, rgba(51, 153, 255, 0.08) 100%);
     box-shadow: 0 12px 40px rgba(77, 166, 255, 0.15);
   }

   .upgrade-header {
     display: flex;
     align-items: center;
     gap: 16px;
     margin-bottom: 20px;
   }

   .upgrade-icon {
     width: 48px;
     height: 48px;
     background: linear-gradient(135deg, #4da6ff 0%, #3399ff 100%);
     border-radius: 12px;
     display: flex;
     align-items: center;
     justify-content: center;
     color: white;
     flex-shrink: 0;
     transition: all 0.3s ease;
     position: relative;
     overflow: hidden;
   }

   .upgrade-icon::before {
     content: '';
     position: absolute;
     top: -50%;
     left: -50%;
     width: 200%;
     height: 200%;
     background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
     transform: rotate(45deg);
     transition: all 0.6s ease;
     opacity: 0;
   }

   .upgrade-plan-card:hover .upgrade-icon::before {
     animation: shimmer 0.8s ease-in-out;
   }

   .upgrade-icon:hover {
     transform: scale(1.05);
   }

   .upgrade-title {
     margin: 0;
     font-size: 18px;
     font-weight: 600;
     color: #1d1d1f;
     line-height: 1.3;
   }

   .upgrade-subtitle {
     margin: 4px 0 0 0;
     font-size: 14px;
     color: #86868b;
     line-height: 1.4;
   }

   .upgrade-features {
     display: flex;
     flex-direction: column;
     gap: 12px;
     margin-bottom: 24px;
   }

   .feature-item {
     display: flex;
     align-items: center;
     gap: 12px;
     font-size: 14px;
     color: #5a5a5f;
     transition: all 0.2s ease;
   }

   .feature-item:hover {
     color: #1d1d1f;
     transform: translateX(4px);
   }

   .feature-item svg {
     color: #4da6ff;
     flex-shrink: 0;
     transition: transform 0.2s ease;
   }

   .feature-item:hover svg {
     transform: scale(1.1);
   }

   .upgrade-btn {
     width: 100%;
     background: linear-gradient(135deg, #4da6ff 0%, #3399ff 100%);
     border: none;
     border-radius: 14px;
     padding: 16px 24px;
     color: white;
     font-size: 15px;
     font-weight: 600;
     cursor: pointer;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 10px;
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
     position: relative;
     overflow: hidden;
     box-shadow: 0 4px 16px rgba(77, 166, 255, 0.25);
   }

   .upgrade-btn::before {
     content: '';
     position: absolute;
     top: 0;
     left: -100%;
     width: 100%;
     height: 100%;
     background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
     transition: left 0.5s ease;
   }

   .upgrade-btn:hover::before {
     left: 100%;
   }

   .upgrade-btn:hover {
     transform: translateY(-2px);
     background: linear-gradient(135deg, #3399ff 0%, #1a8cff 100%);
     box-shadow: 0 8px 25px rgba(77, 166, 255, 0.35);
   }

   .upgrade-btn:active {
     transform: translateY(0);
     box-shadow: 0 2px 8px rgba(77, 166, 255, 0.25);
   }

   .upgrade-btn svg {
     transition: transform 0.2s ease;
   }

   .upgrade-btn:hover svg {
     transform: translateX(2px);
   }

   /* 统计信息网格布局 */
   .profile-stats-grid {
     display: grid;
     grid-template-columns: 1fr 1fr;
     gap: 16px;
     margin-bottom: 24px;
     animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.25s both;
   }

   .stat-card {
     background: rgba(250,250,250,0.5);
     backdrop-filter: blur(10px);
     border: 1px solid rgba(0,0,0,0.04);
     border-radius: 16px;
     padding: 24px;
     display: flex;
     align-items: center;
     gap: 16px;
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
     position: relative;
     overflow: hidden;
   }

   .stat-card::before {
     content: '';
     position: absolute;
     top: 0;
     left: 0;
     right: 0;
     height: 1px;
     background: linear-gradient(90deg, transparent, rgba(77, 166, 255, 0.2), transparent);
     opacity: 0;
     transition: opacity 0.3s ease;
   }

   .stat-card:hover {
     transform: translateY(-2px);
     border-color: rgba(77, 166, 255, 0.15);
     background: rgba(250,250,250,0.8);
     box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
   }

   .stat-card:hover::before {
     opacity: 1;
   }

   .stat-icon {
     width: 44px;
     height: 44px;
     background: rgba(77, 166, 255, 0.1);
     border-radius: 12px;
     display: flex;
     align-items: center;
     justify-content: center;
     color: #4da6ff;
     flex-shrink: 0;
     transition: all 0.3s ease;
   }

   .stat-card:hover .stat-icon {
     background: rgba(77, 166, 255, 0.15);
     transform: scale(1.05);
   }

   .stat-content {
     flex: 1;
   }

   .stat-card .stat-value {
     font-size: 22px;
     font-weight: 600;
     color: #1d1d1f;
     margin-bottom: 4px;
     line-height: 1.2;
     background: linear-gradient(135deg, #1d1d1f, #3a3a3c);
     -webkit-background-clip: text;
     -webkit-text-fill-color: transparent;
     background-clip: text;
     transition: all 0.3s ease;
   }

   .stat-card:hover .stat-value {
     background: linear-gradient(135deg, #4da6ff, #3399ff);
     -webkit-background-clip: text;
     -webkit-text-fill-color: transparent;
     background-clip: text;
     transform: scale(1.02);
   }

   .stat-card .stat-label {
     font-size: 12px;
     color: #86868b;
     font-weight: 500;
     letter-spacing: 0.2px;
     line-height: 1.3;
   }

   .stat-item:nth-child(2) {
     animation-delay: 0.4s;
   }

   /* 响应式细节优化 */
   @media (max-width: 640px) {
     .profile-section {
       padding: 16px;
     }
     
     .profile-card {
       padding: 24px;
       flex-direction: column;
       text-align: center;
       gap: 20px;
     }
     
     .profile-avatar {
       width: 72px;
       height: 72px;
     }
     
     .profile-name {
       font-size: 22px;
     }
     
     .profile-stats {
       padding: 20px 24px;
       gap: 24px;
     }
     
     .stat-item:not(:last-child)::after {
       right: -12px;
       height: 20px;
     }
     
     .stat-value {
       font-size: 24px;
     }
     
     .profile-actions {
       padding: 0 24px;
       flex-direction: column;
       gap: 12px;
     }
     
     .profile-action-btn {
       min-width: auto;
       width: 100%;
     }
   }

   /* 自动补全样式 */
   .editor-wrapper {
     position: relative;
     width: 100%;
     height: 100%;
   }

   .auto-complete-overlay {
      position: absolute;
      pointer-events: none;
      font-size: 16px;
      line-height: 1.6;
      white-space: nowrap;
      z-index: 1000; /* 提高z-index确保显示在textarea之上 */
      display: none;
      background: transparent;
    }

   .auto-complete-suggestion {
     color: rgba(128, 128, 128, 0.6);
     background: rgba(100, 149, 237, 0.1);
     border-radius: 3px;
     padding: 0 2px;
     animation: fadeIn 0.2s ease-in;
     font-size: 16px;
     line-height: 1.6;
   }

   @keyframes fadeIn {
     from {
       opacity: 0;
     }
     to {
       opacity: 1;
     }
   }

   /* 确保textarea在overlay之上 */
   #noteBody {
     position: relative;
     z-index: 2;
     background: transparent;
   }

    .main {
      flex:1;
    display:flex;
    flex-direction:column;
    padding: 0;
    background: white;
  }

  /* 搜索与新建 */
  .controls { 
    display: flex; 
    gap: 10px; 
    align-items: center;
    padding: 8px 0;
  }
  .search {
    flex:1;
    background: rgba(250,250,250,0.75);
    border: 1px solid rgba(0,0,0,0.04);
    padding: 7px 12px;
    border-radius: 10px;
    outline: none;
    font-size: 13px;
    transition: all 0.2s ease;
  }
  
  .search:focus {
    background: white;
    border-color: rgba(10, 132, 255, 0.3);
    box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
  }
  .new-btn {
    background: linear-gradient(135deg, #4da6ff, #3399ff);
    color: white;
    border: none;
    padding: 8px;
    font-size: 16px;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(51, 153, 255, 0.3);
  }
  
  .new-btn:hover {
    background: linear-gradient(135deg, #3399ff, #1a8cff);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(51, 153, 255, 0.4);
  }
  
  .new-btn:active { 
    transform: translateY(0);
    box-shadow: 0 1px 4px rgba(51, 153, 255, 0.3);
  }

  .new-btn i {
    transform: translateY(2px);
  }

  /* 笔记列表 */
  .notes-list { overflow:auto; padding-top:6px; display:flex; flex-direction:column; gap:8px; }
  .note-item {
    padding:10px;
    border-radius:10px;
    cursor:pointer;
    display:flex;
    gap:10px;
    align-items:flex-start;
  }
  .note-item:hover { background: rgba(10,132,255,0.04); }
  .note-item.active { background: rgba(10,132,255,0.08); }
  .note-title { font-weight:600; font-size:14px; color:#111; }
  .note-excerpt { font-size:13px; color:#666; margin-top:6px; max-height:36px; overflow:hidden; }

  .meta { font-size:12px; color:#8a8a8a; margin-top:6px; }

  /* 编辑区 */

  .title-input {
    font-size:18px;
    font-weight:600;
    border:none;
    outline:none;
    background:transparent;
    flex:1;
  }
  .editor-wrap { display:flex; gap:0; flex:1; min-height:0; }
  .editor-unified, .preview {
    flex:1;
    border-radius:0;
    padding:20px;
    border:none;
    background: transparent;
    min-height:0; /* 重要，确保内容区可滚动 */
    overflow:auto;
    display:flex;
    flex-direction:column;
  }
  
  /* 编辑器和预览区域之间的固定分隔线 */
  .editor-unified {
    border-right: 1px solid #e5e5e7;
  }
  .editor-top-unified {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
    padding-bottom:0;
  }
  .editor-unified textarea {
    width:100%; height:100%; resize:none; border:none; outline:none; background:transparent; 
    font-size:16px; line-height:1.6; flex:1;
  }
  .footer {
    margin-top:10px; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; font-size:12px; color:#7a7a7a;
  }

  /* 同步状态样式 */
  .sync-status {
    font-size: 11px;
    margin-left: 8px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
  }

  .sync-status--success {
    background: rgba(76, 217, 100, 0.1);
    color: #4cd964;
  }

  .sync-status--error {
    background: rgba(255, 59, 48, 0.1);
    color: #ff3b30;
  }

  .sync-status--info {
    background: rgba(0, 122, 255, 0.1);
    color: #007aff;
  }

  /* 小屏适配 */
  @media (max-width: 980px) {
    .app-root { width: 100vw; height: 100vh; }
    .sidebar { width: 240px; }
  }

  /* 代码高亮简易样式 for preview */
  .preview pre { background: #0b1220; color:#e6eef8; padding:8px; border-radius:8px; overflow:auto; }
  .tag { font-size:12px; color:#0A84FF; padding:2px 8px; border-radius:999px; background: rgba(10,132,255,0.08); }

  /* 设置页面样式 */
  .settings-page {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: white;
    z-index: 1000;
    overflow-y: auto;
  }

  .settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e5e5e7;
  }

  .settings-header h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #1d1d1f;
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: #86868b;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
  }

  .close-btn:hover {
    background-color: #f5f5f7;
  }

  .settings-content {
    padding: 20px;
  }

  .setting-item {
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid #f5f5f7;
  }

  .setting-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .setting-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    margin-bottom: 8px;
  }

  .setting-label span {
    font-size: 16px;
    font-weight: 500;
    color: #1d1d1f;
  }

  .setting-description {
    margin: 0;
    font-size: 14px;
    color: #86868b;
    line-height: 1.4;
  }

  /* 切换开关样式 */
  .toggle-switch {
    position: relative;
    width: 50px;
    height: 30px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 30px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: #007AFF;
  }

  input:checked + .slider:before {
    transform: translateX(20px);
  }

  /* 登录界面样式 */
  .login-form {
    max-width: 400px;
    margin: 0 auto;
    animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .login-item {
    margin-bottom: 24px;
  }

  .login-label {
    display: block;
    font-size: 15px;
    font-weight: 500;
    color: #1d1d1f;
    margin-bottom: 8px;
    transition: color 0.2s ease;
  }

  .login-input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid rgba(0,0,0,0.08);
    border-radius: 12px;
    font-size: 16px;
    background: rgba(250,250,250,0.5);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-sizing: border-box;
    backdrop-filter: blur(10px);
  }

  .login-input:focus {
    outline: none;
    border-color: #4da6ff;
    background: white;
    box-shadow: 0 0 0 3px rgba(77, 166, 255, 0.15);
    transform: translateY(-1px);
  }

  .login-input:hover {
    border-color: rgba(0,0,0,0.15);
    background: rgba(250,250,250,0.8);
  }

  .login-checkbox-label {
    display: flex;
    align-items: center;
    font-size: 15px;
    color: #1d1d1f;
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .login-checkbox-label:hover {
    color: #4da6ff;
  }

  .login-checkbox {
    margin-right: 10px;
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 1px solid rgba(0,0,0,0.2);
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .login-checkbox:checked {
    background: #4da6ff;
    border-color: #4da6ff;
  }

  .login-buttons {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
  }

  .login-btn {
    flex: 1;
    padding: 14px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .login-btn.primary {
    background: linear-gradient(135deg, #4da6ff, #3399ff);
    color: white;
    box-shadow: 0 2px 8px rgba(77, 166, 255, 0.3);
  }

  .login-btn.primary:hover {
    background: linear-gradient(135deg, #3399ff, #1a8cff);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(77, 166, 255, 0.4);
  }

  .login-btn.primary:active {
    transform: translateY(0);
    box-shadow: 0 1px 4px rgba(77, 166, 255, 0.3);
  }

  .login-btn.secondary {
    background: rgba(250,250,250,0.8);
    color: #1d1d1f;
    border: 1px solid rgba(0,0,0,0.08);
    backdrop-filter: blur(10px);
  }

  .login-btn.secondary:hover {
    background: rgba(240,240,240,0.9);
    border-color: rgba(0,0,0,0.15);
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .login-btn.secondary:active {
    transform: translateY(0);
    box-shadow: none;
  }

  .login-divider {
    text-align: center;
    margin: 24px 0;
    position: relative;
  }

  .login-divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #d1d1d6;
  }

  .login-divider span {
    background: white;
    padding: 0 16px;
    color: #86868b;
    font-size: 14px;
  }

  .social-login {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
  }

  .social-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    border: 1px solid #d1d1d6;
    border-radius: 8px;
    background: white;
    color: #1d1d1f;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .social-btn:hover {
    background: #f5f5f7;
    transform: translateY(-1px);
  }

  .social-btn.apple {
    border-color: #000;
  }

  .social-btn.google {
    border-color: #4285f4;
  }

  .login-footer {
    text-align: center;
    color: #999999;
    font-size: 14px;
  }

  .forgot-password {
    color: #4da6ff;
    text-decoration: none;
    font-size: 15px;
    font-weight: 500;
    transition: all 0.2s ease;
    position: relative;
  }

  /* 验证码样式 */
  .verification-code-container {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .verification-code-input {
    flex: 1;
    min-width: 0;
  }

  .verification-code-btn {
    padding: 14px 16px;
    border: 1px solid #4da6ff;
    border-radius: 12px;
    background: #4da6ff;
    color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
    min-width: 100px;
  }

  .verification-code-btn:hover {
    background: #3399ff;
    border-color: #3399ff;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(77, 166, 255, 0.3);
  }

  .verification-code-btn:active {
    transform: translateY(0);
    box-shadow: none;
  }

  .verification-code-btn:disabled {
    background: #cccccc;
    border-color: #cccccc;
    color: #999999;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .verification-code-btn.countdown {
    background: #f5f5f7;
    border-color: #d1d1d6;
    color: #86868b;
  }

  .forgot-password:hover {
    color: #3399ff;
    text-decoration: none;
    transform: translateY(-1px);
  }

  .forgot-password::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 1px;
    background: #4da6ff;
    transition: width 0.3s ease;
  }

  .forgot-password:hover::after {
    width: 100%;
  }

  /* 液态玻璃模式样式 */
  .liquid-glass-mode .app-root {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .liquid-glass-mode .titlebar {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px) saturate(150%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    transition: all 0.3s ease-in-out;
  }

  .liquid-glass-mode .sidebar {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(12px) saturate(140%);
    border-right: 1px solid rgba(255, 255, 255, 0.12);
    transition: all 0.3s ease-in-out;
  }

  .liquid-glass-mode .main-content {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px) saturate(130%);
    transition: all 0.3s ease-in-out;
  }

  .liquid-glass-mode .note-item {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(8px) saturate(120%);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    margin-bottom: 8px;
  }

  .liquid-glass-mode .note-item:hover {
    background: rgba(255, 255, 255, 0.18);
    backdrop-filter: blur(12px) saturate(140%);
    border-color: rgba(255, 255, 255, 0.25);
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(31, 38, 135, 0.2);
  }

  .liquid-glass-mode .note-item.selected {
    background: rgba(0, 122, 255, 0.15);
    backdrop-filter: blur(15px) saturate(160%);
    border-color: rgba(0, 122, 255, 0.3);
    box-shadow: 0 4px 20px rgba(0, 122, 255, 0.25);
  }

  .liquid-glass-mode .editor-area {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px) saturate(125%);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    transition: all 0.3s ease-in-out;
  }

  .liquid-glass-mode .editor-area:focus-within {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(15px) saturate(140%);
    border-color: rgba(0, 122, 255, 0.3);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
  }

  .liquid-glass-mode #noteTitle {
    background: transparent;
    border: none;
    border-radius: 12px;
    transition: all 0.2s ease-in-out;
  }

  .liquid-glass-mode #noteBody {
    background: transparent;
    border: none;
    border-radius: 12px;
    transition: all 0.2s ease-in-out;
  }

  .liquid-glass-mode .action-btn {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(8px) saturate(120%);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .liquid-glass-mode .action-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(12px) saturate(140%);
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(31, 38, 135, 0.15);
  }

  .liquid-glass-mode .footer {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px) saturate(130%);
    border-top: 1px solid rgba(255, 255, 255, 0.15);
    transition: all 0.3s ease-in-out;
  }

  .liquid-glass-mode .settings-page {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(20px) saturate(150%);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    transition: all 0.3s ease-in-out;
  }

  .liquid-glass-mode .setting-item {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(8px) saturate(120%);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 14px;
    transition: all 0.25s ease-in-out;
  }

  .liquid-glass-mode .setting-item:hover {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(12px) saturate(140%);
    border-color: rgba(255, 255, 255, 0.2);
    transform: translateY(-1px);
  }

  .liquid-glass-mode .ai-assistant-input {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(10px) saturate(130%);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 14px;
    transition: all 0.3s ease-in-out;
  }

  .liquid-glass-mode .ai-assistant-input:focus-within {
    background: rgba(255, 255, 255, 0.18);
    backdrop-filter: blur(15px) saturate(150%);
    border-color: rgba(0, 122, 255, 0.4);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
  }

  /* 丝滑动画效果 */
  .liquid-glass-mode * {
    transition-timing-function: cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .liquid-glass-mode .note-item,
  .liquid-glass-mode .action-btn,
  .liquid-glass-mode .setting-item {
    animation: liquidGlassFloat 6s ease-in-out infinite;
  }

  @keyframes liquidGlassFloat {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-2px); }
  }

  /* 确保文字清晰可读 */
  .liquid-glass-mode .note-item .note-title,
  .liquid-glass-mode .note-item .note-preview,
  .liquid-glass-mode #noteTitle,
  .liquid-glass-mode #noteBody,
  .liquid-glass-mode .setting-label span,
  .liquid-glass-mode .setting-description {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    color: rgba(0, 0, 0, 0.85);
    font-weight: 500;
  }

  .liquid-glass-mode .titlebar .title {
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    color: rgba(0, 0, 0, 0.8);
    font-weight: 600;
  }


/* 自定义弹窗样式 */
.modal-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(4px);
  z-index: 10000 !important;
  opacity: 0;
  transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  pointer-events: none;
}

.modal-overlay.active {
  opacity: 1;
  pointer-events: auto;
}

.modal-overlay.active {
  opacity: 1;
}

.modal-container {
  background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,250,250,0.95));
  border-radius: 16px;
  padding: 0;
  width: 400px;
  max-width: 90vw;
  max-height: 90vh;
  box-shadow: 0 24px 48px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(20px);
  transform: scale(0.9) translateY(20px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: auto;
  position: absolute !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) scale(0.9) !important;
}

.modal-overlay.active .modal-container {
  transform: translate(-50%, -50%) scale(1) !important;
}

.modal-header {
  padding: 24px 24px 16px;
  border-bottom: 1px solid rgba(0,0,0,0.04);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-title {
  font-size: 18px;
  font-weight: 600;
  color: #111;
  margin: 0;
}

.modal-close {
  background: none;
  border: none;
  font-size: 20px;
  color: #666;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.modal-close:hover {
  background: rgba(0,0,0,0.06);
  color: #333;
}

.modal-body {
  padding: 24px;
  color: #333;
  line-height: 1.5;
}

.modal-message {
  font-size: 15px;
  margin: 0 0 20px;
}

.modal-input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 10px;
  font-size: 14px;
  background: rgba(255,255,255,0.8);
  transition: all 0.2s ease;
  margin-bottom: 20px;
}

.modal-input:focus {
  outline: none;
  border-color: #0A84FF;
  box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.15);
}

.modal-footer {
  padding: 16px 24px 24px;
  border-top: 1px solid rgba(0,0,0,0.04);
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.modal-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  min-width: 80px;
}

.modal-btn.primary {
  background: #0A84FF;
  color: white;
}

.modal-btn.primary:hover {
  background: #0056b3;
  transform: translateY(-1px);
}

.modal-btn.secondary {
  background: rgba(0,0,0,0.06);
  color: #666;
}

.modal-btn.secondary:hover {
  background: rgba(0,0,0,0.12);
  color: #333;
}

.modal-btn.danger {
  background: #ff3b30;
  color: white;
}

.modal-btn.danger:hover {
  background: #d70015;
  transform: translateY(-1px);
}

/* 弹窗图标 */
.modal-icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
  font-size: 24px;
}

.modal-icon-svg {
  width: 60%;
  height: 60%;
}

.modal-icon.info {
  background: rgba(10, 132, 255, 0.1);
}

.modal-icon.info .modal-icon-svg {
  filter: invert(40%) sepia(90%) saturate(2000%) hue-rotate(200deg) brightness(100%) contrast(100%); /* 蓝色 */
}

.modal-icon.warning {
  background: rgba(255, 149, 0, 0.1);
}

.modal-icon.warning .modal-icon-svg {
  filter: invert(60%) sepia(90%) saturate(2000%) hue-rotate(0deg) brightness(100%) contrast(100%); /* 橙色 */
}

.modal-icon.error {
  background: rgba(255, 59, 48, 0.1);
}

.modal-icon.error .modal-icon-svg {
  filter: invert(30%) sepia(90%) saturate(2000%) hue-rotate(340deg) brightness(100%) contrast(100%); /* 红色 */
}

.modal-icon.success {
  background: rgba(52, 199, 89, 0.1);
}

.modal-icon.success .modal-icon-svg {
  filter: invert(50%) sepia(90%) saturate(2000%) hue-rotate(90deg) brightness(100%) contrast(100%); /* 绿色 */
}
</style>
</head>
<body>

<div class="app-root" role="application" aria-label="Minimal Notes app">
  <div style="display:flex;flex-direction:column;width:100%">
    <div class="titlebar">
      <div class="win-controls" aria-hidden="true">
        <span class="dot red"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
      </div>
      <div class="app-title">Notes</div>
      <button id="toggleSidebarBtn" class="action-btn" title="收缩/展开侧边栏" data-i18n="toggle-sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 24 24">
          <path fill="currentColor" fill-rule="evenodd" d="M21 5H11v14h10zM3 5h6v14H3zm0-2a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h18a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2zm2 4.25a.75.75 0 0 0 0 1.5h2a.75.75 0 0 0 0-1.5zm-.75 3.5A.75.75 0 0 1 5 10h2a.75.75 0 0 1 0 1.5H5a.75.75 0 0 1-.75-.75m.75 2a.75.75 0 0 0 0 1.5h2a.75.75 0 0 0 0-1.5z" clip-rule="evenodd"/>
        </svg>
      </button>
      <div class="title-spacer" aria-hidden="true"></div>
      <div class="title-actions">
        <button title="Markdown转换" id="markdownBtn" class="action-btn" data-i18n="markdown-convert">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 24 24">
            <path fill="currentColor" fill-rule="evenodd" d="M13.113 2.266a.936.936 0 0 1 .797 1.057l-2.476 17.614a.936.936 0 0 1-1.854-.26l2.476-17.615a.936.936 0 0 1 1.057-.796M6.811 6.744a.936.936 0 0 1 0 1.324l-3.55 3.55 3.55 3.551a.936.936 0 1 1-1.324 1.324l-4.213-4.212a.936.936 0 0 1 0-1.325l4.213-4.212a.936.936 0 0 1 1.324 0m15.447 4.213c.357.356.365.93.025 1.297a6.05 6.05 0 0 0-2.377-1.001l-3.185-3.185a.936.936 0 1 1 1.324-1.324zm-3.47 10.491a.48.48 0 0 0 .48-.425c.225-1.341.423-2.03.849-2.457.425-.426 1.11-.624 2.445-.849a.485.485 0 0 0 .438-.48.48.48 0 0 0-.44-.48c-1.332-.227-2.018-.425-2.443-.851-.426-.427-.624-1.115-.849-2.455a.48.48 0 0 0-.48-.428.49.49 0 0 0-.481.426c-.226 1.341-.423 2.03-.85 2.457-.424.426-1.108.624-2.44.85a.48.48 0 0 0-.442.481c0 .26.199.448.439.48 1.335.225 2.02.418 2.444.842.426.425.623 1.114.849 2.466.04.24.23.423.482.423" clip-rule="evenodd"/>
          </svg>
        </button>
        <button title="AI优化笔记" id="aiOptimizeBtn" class="action-btn" data-i18n="ai-optimize">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 24 24">
            <path fill="currentColor" fill-rule="evenodd" d="m18.151 3.814-.715.716 1.134 1.134.715-.716zm-8.046 8.047 6.27-6.27 1.134 1.134-6.27 6.27-1.4.266zm-.667 3.512 2.174-.414a2 2 0 0 0 1.041-.55l8.754-8.754a1 1 0 0 0 0-1.414l-2.549-2.548a1 1 0 0 0-1.414 0l-8.753 8.753a2 2 0 0 0-.55 1.041l-.414 2.175-.027.144-.237 1.246a.5.5 0 0 0 .584.585l1.246-.237.144-.027M7.444 3.253c2.223-.846 4.838-.778 7.16.301l-1.535 1.534c-1.646-.574-3.407-.54-4.915.034-2.474.94-4.336 3.362-3.744 7.212.446 2.895 2.184 4.882 4.184 6.19 2.023 1.322 4.231 1.891 5.39 1.964a1 1 0 1 1-.124 1.996c-1.508-.094-4.05-.776-6.36-2.286-2.333-1.526-4.512-3.955-5.066-7.56-.736-4.78 1.652-8.11 5.01-9.386m6.854 15.725c-2.242-.28-4.011-1.304-5.21-2.317l2.802-.51a7.8 7.8 0 0 0 2.62.838c1.859.088 3.008-.236 3.703-.688.67-.436 1.024-1.059 1.162-1.839.233-1.323-.185-2.996-.809-4.433l1.488-1.537c.865 1.726 1.668 4.178 1.29 6.317-.216 1.229-.83 2.38-2.04 3.168-1.181.768-2.813 1.114-4.932 1.008l-.037-.002z" clip-rule="evenodd"/>
          </svg>
        </button>
        <button title="AI翻译" id="aiTranslateBtn" class="action-btn" data-i18n="ai-translate">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor">
            <path d="m19,4H5c-2.761,0-5,2.238-5,5v6c0,2.761,2.239,5,5,5h14c2.757,0,5-2.243,5-5v-6c0-2.757-2.243-5-5-5Zm-10.878,12h-.002c-.326,0-.609-.225-.682-.543l-.265-1.157h-2.409l-.274,1.161c-.075.316-.356.539-.681.539-.451,0-.784-.421-.681-.86l1.413-5.993c.201-.866,1.137-1.406,2.056-1.021.439.184.734.606.842,1.07l1.363,5.948c.1.438-.232.856-.682.856Zm13.878-1c0,1.654-1.346,3-3,3h-7V6h7c1.654,0,3,1.346,3,3v6Zm-1.5-5.384v.021c0,.34-.276.616-.616.616h-.316c-.121,1.275-.617,2.731-1.607,3.866.542.329,1.192.564,1.984.639.315.03.555.296.555.613v.021c0,.366-.316.648-.68.613-1.137-.109-2.059-.489-2.808-1.022-.753.538-1.686.915-2.832,1.022-.364.034-.679-.248-.679-.614v-.021c0-.321.248-.584.568-.614.788-.075,1.438-.307,1.977-.635-.331-.379-.607-.794-.833-1.227-.213-.408.089-.896.549-.896h.01c.226,0,.437.122.541.322.185.352.416.691.693,1.002.818-.92,1.192-2.108,1.303-3.071h-4.191c-.34,0-.616-.276-.616-.616v-.021c0-.34.276-.616.616-.616h2.257v-.384c0-.34.276-.616.616-.616h.021c.34,0,.616.276.616.616v.384h2.257c.34,0,.616.276.616.616Zm-14.435-.153l.787,3.437h-1.757l.811-3.437c.009-.037.041-.063.079-.063s.071.026.079.063Z"/>
          </svg>
        </button>
        <button title="AI智能助手" id="aiAssistantBtn" class="action-btn" data-i18n="ai-assist">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M2.059 6.209c-.14-.932-.098-2.259.897-3.253.994-.995 2.321-1.037 3.253-.897.98.147 2.02.556 3.026 1.084.878.46 1.81 1.052 2.765 1.753a22 22 0 0 1 2.765-1.753c1.007-.527 2.046-.937 3.026-1.084.932-.14 2.259-.097 3.253.897s1.037 2.321.897 3.253c-.147.98-.557 2.02-1.084 3.026-.46.878-1.052 1.81-1.753 2.765a22 22 0 0 1 1.753 2.765c.527 1.007.937 2.046 1.084 3.026.14.932.098 2.259-.897 3.253-.994.994-2.321 1.037-3.253.897-.98-.147-2.02-.557-3.026-1.084A22 22 0 0 1 12 19.104a22 22 0 0 1-2.766 1.754c-1.006.527-2.045.936-3.025 1.083-.932.14-2.259.098-3.253-.897-.995-.994-1.037-2.321-.897-3.253.147-.98.556-2.02 1.084-3.026A22 22 0 0 1 4.896 12a22 22 0 0 1-1.753-2.766C2.616 8.228 2.206 7.19 2.059 6.21m2.325-1.825c.892-.892 3.238-.1 5.969 1.816-.724.613-1.45 1.28-2.161 1.992a36 36 0 0 0-1.992 2.16c-1.916-2.73-2.708-5.076-1.816-5.968M9.62 9.62A33 33 0 0 0 7.455 12a33 33 0 0 0 2.165 2.38A33 33 0 0 0 12 16.545a33 33 0 0 0 2.38-2.165A33 33 0 0 0 16.545 12a33 33 0 0 0-2.165-2.38A33 33 0 0 0 12 7.455 33 33 0 0 0 9.62 9.62m-5.236 9.996c-.892-.892-.1-3.238 1.816-5.969.613.724 1.28 1.449 1.992 2.16.712.713 1.437 1.38 2.161 1.993-2.73 1.916-5.077 2.708-5.97 1.816m15.232 0c-.892.892-3.238.1-5.969-1.816a36 36 0 0 0 2.16-1.992 36 36 0 0 0 1.993-2.161c1.916 2.73 2.708 5.077 1.816 5.969M15.808 8.192a36 36 0 0 1 1.992 2.16c1.915-2.73 2.708-5.076 1.816-5.968s-3.238-.1-5.969 1.816c.724.613 1.45 1.28 2.161 1.992"></path></svg>
        </button>
        <button title="自动补全开关" id="autoCompleteToggleBtn" class="action-btn" data-enabled="false" data-i18n="auto-complete">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19,22H5a5.006,5.006,0,0,1-5-5V7A5.006,5.006,0,0,1,5,2H19a5.006,5.006,0,0,1,5,5V17A5.006,5.006,0,0,1,19,22ZM5,4A3,3,0,0,0,2,7V17a3,3,0,0,0,3,3H19a3,3,0,0,0,3-3V7a3,3,0,0,0-3-3Z"/>
            <path d="M19,13H11a1,1,0,0,1,0-2h8a1,1,0,0,1,0,2Z"/>
            <path d="M7,13H5a1,1,0,0,1,0-2H7a1,1,0,0,1,0,2Z"/>
            <path d="M13,18H5a1,1,0,0,1,0-2h8a1,1,0,0,1,0,2Z"/>
            <path d="M19,18H17a1,1,0,0,1,0-2h2a1,1,0,0,1,0,2Z"/>
          </svg>
        </button>
        <button title="导入笔记 (仅支持 TXT/MD)" id="importBtn" class="action-btn" data-i18n="import">导入</button>
        <button title="导出" id="exportBtn" class="action-btn" data-i18n="export">导出</button>
        <button title="预览" id="togglePreview" class="action-btn" data-i18n="preview">预览</button>
      </div>
    </div>

    <!-- 导出格式弹窗（使用原生 dialog，避免引入复杂样式） -->
    <dialog id="exportDialog" style="border:none;border-radius:12px;padding:20px;max-width:360px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.12)">
      <h3 style="margin:0 0 12px;font-size:18px">选择导出格式</h3>
      <p style="margin:0 0 16px;color:#555">请选择要导出的文件格式：</p>
      <div style="display:flex;gap:10px;justify-content:flex-end">
        <button id="exportCancelBtn" class="action-btn" style="background:#f0f2f5;color:#333">取消</button>
        <button id="exportTxtOption" class="action-btn" style="background:#0A84FF;color:#fff">TXT</button>
        <button id="exportMdOption" class="action-btn" style="background:#0A84FF;color:#fff">MD</button>
      </div>
    </dialog>

    <div class="container">
      <aside class="sidebar" role="navigation" aria-label="Notes list">
        <div class="controls">
          <input id="searchInput" class="search" placeholder="搜索笔记 (⌘/Ctrl+F)" data-i18n="search-placeholder" />
          <button id="newNoteBtn" class="new-btn" title="新建笔记 (⌘/Ctrl+N)" data-i18n="new-note"><i class="fi fi-rr-add"></i></button>
        </div>

        <div id="notesList" class="notes-list" role="list" tabindex="0" aria-label="Notes"></div>
      </aside>

      <main class="main" role="main">
        <!-- AI助手输入框 -->
        <div id="aiInputContainer" class="ai-input-container" style="display: none;">
          <div class="ai-input-wrapper">
            <input type="text" id="aiCustomInput" placeholder="请输入您的个性化要求..." data-i18n="ai-assistant-placeholder" />
            <button id="aiSubmitBtn" class="ai-submit-btn" data-i18n="send">发送</button>
            <button id="aiCancelBtn" class="ai-cancel-btn" data-i18n="cancel">取消</button>
          </div>
        </div>
        
        <div class="editor-wrap">
          <section class="editor-unified" aria-label="Editor">
            <div class="editor-top-unified">
              <input id="noteTitle" class="title-input" placeholder="无标题" data-i18n="note-title-placeholder" />
              <div style="display:flex;gap:8px;align-items:center">
                <div id="noteTags" style="display:flex;gap:6px;align-items:center"></div>
                <div style="width:8px"></div>
              </div>
            </div>
            <div class="editor-wrapper">
              <textarea id="noteBody" placeholder="开始输入你的笔记…（支持 Markdown，自动保存）" data-i18n="note-content-placeholder"></textarea>
              <div id="autoComplete" class="auto-complete-overlay"></div>
            </div>
          </section>

          <section id="preview" class="preview" aria-label="Preview" style="display:none">
            <!-- Markdown preview goes here -->
          </section>
        </div>

        <div class="footer">
          <div id="status" data-i18n="status-unsaved">未保存</div>
          <div>
            <button id="deleteBtn" class="action-btn"><i class="fi fi-rr-trash"></i></button>
            <button id="settingsBtn" class="action-btn"><i class="fi fi-rs-gears"></i></button>
            <button id="profileBtn" class="action-btn" title="个人资料" data-i18n="profile"><i class="fi fi-bs-user"></i></button>
            <button id="rechargeBtn" class="action-btn" title="充值" data-i18n="recharge"><img src="000.svg" alt="充值" style="width: 16px; height: 16px;"></button>
          </div>
        </div>
      </main>

      <!-- 设置页面 -->
      <div id="settingsPage" class="settings-page" style="display: none;">
        <div class="settings-header">
          <h2 data-i18n="settings-title">个性化设置</h2>
          <button id="closeSettingsBtn" class="close-btn">&times;</button>
        </div>
        <div class="settings-content">
          <div class="setting-item">
            <label class="setting-label">
              <span data-i18n="borderless-mode">无边际模式</span>
              <div class="toggle-switch">
                <input type="checkbox" id="borderlessToggle" checked>
                <span class="slider"></span>
              </div>
            </label>
            <p class="setting-description" data-i18n="borderless-mode-desc">开启后，编辑区域将没有边框，呈现更简洁的界面</p>
          </div>
          
          <div class="setting-item">
            <label class="setting-label">
              <span data-i18n="divider-lines">显示分割线</span>
              <div class="toggle-switch">
                <input type="checkbox" id="dividerToggle">
                <span class="slider"></span>
              </div>
            </label>
            <p class="setting-description" data-i18n="divider-lines-desc">在标题和内容区域之间显示分割线</p>
          </div>
          
          <div class="setting-item">
            <label class="setting-label">
              <span data-i18n="liquid-glass-mode">液态玻璃模式</span>
              <div class="toggle-switch">
                <input type="checkbox" id="liquidGlassToggle">
                <span class="slider"></span>
              </div>
            </label>
            <p class="setting-description" data-i18n="liquid-glass-mode-desc">启用iOS 26风格的液态玻璃效果（当前处于Beta测试版）。</p>
          </div>
          
          <div class="setting-item">
            <label class="setting-label">
              <span data-i18n="english-mode">English Version</span>
              <div class="toggle-switch">
                <input type="checkbox" id="englishToggle">
                <span class="slider"></span>
              </div>
            </label>
            <p class="setting-description" data-i18n="english-mode-desc">Switch interface language to English</p>
          </div>
          
          <div class="setting-item">
            <label class="setting-label">
              <span data-i18n="bold-font">字体加粗</span>
              <div class="toggle-switch">
                <input type="checkbox" id="boldFontToggle">
                <span class="slider"></span>
              </div>
            </label>
            <p class="setting-description" data-i18n="bold-font-desc">将界面字体稍微加粗，提升可读性</p>
          </div>
          
          <div class="setting-item">
            <label class="setting-label">
              <span data-i18n="font-size">字体加大</span>
              <div class="toggle-switch">
                <input type="checkbox" id="fontSizeToggle">
                <span class="slider"></span>
              </div>
            </label>
            <p class="setting-description" data-i18n="font-size-desc">将笔记字体稍微加大，提升阅读体验</p>
          </div>
        </div>
      </div>

      <!-- 登录界面 -->
      <div id="loginPage" class="settings-page" style="display: none;">
        <div class="settings-header">
          <h2 data-i18n="login-title">登录</h2>
          <button id="closeLoginBtn" class="close-btn">&times;</button>
        </div>
        <div class="settings-content">
          <!-- 登录/注册切换标签 -->
          <div class="auth-tabs">
            <button id="loginTab" class="auth-tab active" data-i18n="login-tab">登录</button>
            <button id="registerTab" class="auth-tab" data-i18n="register-tab">注册</button>
          </div>
          
          <!-- 登录表单 -->
          <div id="loginForm" class="login-form active">
            <div class="login-item">
              <label class="login-label" data-i18n="username-label">用户名或邮箱</label>
              <input type="text" id="usernameInput" class="login-input" placeholder="请输入用户名或邮箱" data-i18n="username-placeholder" />
            </div>
            
            <div class="login-item">
              <label class="login-label" data-i18n="password-label">密码</label>
              <input type="password" id="passwordInput" class="login-input" placeholder="请输入密码" data-i18n="password-placeholder" />
            </div>
            
            <div class="login-item">
              <label class="login-checkbox-label">
                <input type="checkbox" id="rememberMe" class="login-checkbox">
                <span data-i18n="remember-me">记住我</span>
              </label>
            </div>
            
            <div class="login-buttons">
              <button id="loginBtn" class="login-btn primary" data-i18n="login-btn">登录</button>
            </div>
            
            <div class="login-footer">
              <a href="#" class="forgot-password" data-i18n="forgot-password">忘记密码？</a>
            </div>
          </div>
          
          <!-- 注册表单 -->
          <div id="registerForm" class="login-form">
            <div class="login-item">
              <label class="login-label" data-i18n="name-label">姓名</label>
              <input type="text" id="registerUsername" class="login-input" placeholder="请输入姓名" data-i18n="name-placeholder" />
            </div>
            
            <div class="login-item">
              <label class="login-label" data-i18n="email-label">邮箱</label>
              <input type="email" id="registerEmail" class="login-input" placeholder="请输入邮箱地址" data-i18n="email-placeholder" />
            </div>
            
            <div class="login-item">
              <label class="login-label" data-i18n="verification-code-label">验证码</label>
              <div class="verification-code-container">
                <input type="text" id="verificationCode" class="login-input verification-code-input" placeholder="请输入验证码" data-i18n="verification-code-placeholder" maxlength="6" />
                <button type="button" id="sendVerificationCodeBtn" class="verification-code-btn" data-i18n="send-verification-code-btn">发送验证码</button>
              </div>
            </div>
            
            <div class="login-item">
              <label class="login-label" data-i18n="password-label">密码</label>
              <input type="password" id="registerPassword" class="login-input" placeholder="请输入密码" data-i18n="password-placeholder" />
            </div>
            
            <div class="login-buttons">
              <button id="registerSubmitBtn" class="login-btn primary" data-i18n="register-submit-btn">注册</button>
            </div>
            
            <div class="login-footer">
              <span data-i18n="register-agreement">注册即表示同意我们的服务条款和隐私政策</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 个人资料页面 -->
      <div id="profilePage" class="settings-page" style="display: none;">
        <div class="settings-header">
          <h2 data-i18n="profile-title">个人资料</h2>
          <button id="closeProfileBtn" class="close-btn">&times;</button>
        </div>
        <div class="settings-content">
          <div class="profile-section">
            <!-- 左右分栏布局 -->
            <div class="profile-layout">
              <!-- 左侧栏：个人信息和统计 -->
              <div class="profile-left">
                <!-- 个人信息卡片 -->
                <div class="profile-card">
                  <div class="profile-avatar" id="profileAvatar">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                  </div>
                  <div class="profile-info">
                    <h2 class="profile-name" id="profileUsername">-</h2>
                    <p class="profile-email" id="profileEmail">-</p>
                    <p class="profile-date" id="profileCreatedAt">-</p>
                      <span class="badge-text" id="profileUserType">free</span><span class="badge-expiry" id="profileMembershipExpiry"></span>
                  </div>
                </div>
                
                <!-- 存储使用情况卡片 -->
                <div class="storage-card">
                  <div class="storage-header">
                    <h3 class="storage-title">存储空间</h3>
                    <span class="storage-percentage" id="storagePercentage">0%</span>
                  </div>
                  <div class="storage-visual">
                    <div class="storage-bar">
                      <div class="storage-fill" id="storageProgressFill" style="width: 0%"></div>
                    </div>
                    <div class="storage-details">
                      <span id="storageUsed">0 B</span> / <span id="storageTotal">2 MB</span>
                    </div>
                  </div>
                  <div class="storage-tips">
                    <button class="expand-storage-btn" id="expandStorageBtn">
                      <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                      </svg>
                      <span class="btn-text">扩容云空间</span>
                      <svg class="btn-arrow" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- 右侧栏：存储和升级 -->
              <div class="profile-right">
                <!-- 统计信息卡片 -->
                <div class="stats-card">
                  <h3 class="stats-title">使用统计</h3>
                  <div class="stats-grid">
                    <div class="stat-item">
                      <div class="stat-number" id="profileNoteCount">0</div>
                      <div class="stat-label">笔记数量</div>
                    </div>
                    <div class="stat-item">
                      <div class="stat-number" id="aiRemainingCount">100</div>
                      <div class="stat-label">AI剩余次数</div>
                    </div>
                  </div>
                  
                  <!-- 账户操作区域 -->
                  <div class="account-actions">
                    <button class="account-action-btn cloud-upload-btn" onclick="uploadToCloud()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                        <polyline points="16 16 12 12 8 16"></polyline>
                        <line x1="12" y1="12" x2="12" y2="21"></line>
                      </svg>
                      云上传
                    </button>
                    <button class="account-action-btn logout-btn" onclick="logoutUser()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                      </svg>
                      退出登录
                    </button>
                    <button class="account-action-btn change-password-btn" onclick="showChangePassword()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                      </svg>
                      修改密码
                    </button>
                  </div>
                </div>
                
                <!-- 升级推荐卡片 -->
                <div class="upgrade-card">
                  <div class="upgrade-header">
                    <div class="upgrade-icon">
                      <img src="123321.svg" alt="Upgrade Icon" class="upgrade-svg-icon">
                    </div>
                    <div class="upgrade-title">
                      <h3>升级计划</h3>
                      <p>解锁高级功能</p>
                    </div>
                  </div>
                  <div class="upgrade-features">
                    <div class="feature-item">
                      <svg class="feature-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                        <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                      </svg>
                      <span class="feature-text">更大的存储空间</span>
                    </div>
                    <div class="feature-item">
                      <span class="feature-icon">∞</span>
                      <span class="feature-text">无限制的AI请求</span>
                    </div>
                    <div class="feature-item">
                      <svg class="feature-icon" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
                        <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm0-12l-8 5-8-5h16z"/>
                      </svg>
                      <span class="feature-text">专属的私人客服</span>
                    </div>
                  </div>
                  <button class="upgrade-button" onclick="openUpgradePage()">
                    立即升级
                  </button>
                </div>
              </div>
            </div>
          </div>
          

        </div>
      </div>
    </div>
  </div>
</div>

<input id="hiddenFileInput" type="file" accept=".txt,.md,text/plain,text/markdown" style="display:none" />

<script>
/*
  Minimal Apple-style Notes App (single-file)
  - 存储：localStorage key "minimal_notes_v1"
  - Schema: [{ id, title, content, tags:[], createdAt, updatedAt }]
  - 在 Electron 环境中，可把 localStorage 替换为 ipc 调用：
      window.electronAPI.getNotes() / window.electronAPI.saveNotes(notes)
*/

// API配置
const API_BASE_URL = 'http://113.44.130.103:80/api';

// 用户状态管理
let currentUser = null;
let authToken = localStorage.getItem('authToken');

// API请求函数
async function apiRequest(endpoint, options = {}) {
    const url = `${API_BASE_URL}${endpoint}`;
    const config = {
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        },
        ...options
    };
    
    // 添加认证令牌
    if (authToken) {
        config.headers.Authorization = `Bearer ${authToken}`;
    }
    
    try {
        const response = await fetch(url, config);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.message || `HTTP error! status: ${response.status}`);
        }
        
        return data;
    } catch (error) {
        console.error('API请求失败:', error);
        throw error;
    }
}

// 用户认证函数
async function loginUser(identifier, password) {
    try {
        const result = await apiRequest('/auth/login', {
            method: 'POST',
            body: JSON.stringify({ identifier, password })
        });
        
        if (result.success) {
            currentUser = result.user;
            authToken = result.token;
            localStorage.setItem('authToken', authToken);
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // 初始化AI使用数据
            initializeAIUsageData();
            
            return result;
        }
    } catch (error) {
        throw error;
    }
}

async function registerUser(username, email, password, verificationCode) {
    try {
        const result = await apiRequest('/auth/register', {
            method: 'POST',
            body: JSON.stringify({ username, email, password, verificationCode })
        });
        
        if (result.success) {
            currentUser = result.user;
            authToken = result.token;
            localStorage.setItem('authToken', authToken);
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // 初始化AI使用数据
            initializeAIUsageData();
            
            return result;
        }
    } catch (error) {
        throw error;
    }
}

// 发送验证码函数
async function sendVerificationCode(email) {
    try {
        const result = await apiRequest('/auth/send-verification-code', {
            method: 'POST',
            body: JSON.stringify({ email })
        });
        
        if (result.success) {
            return result;
        }
    } catch (error) {
        throw error;
    }
}

async function verifyToken() {
    try {
        const result = await apiRequest('/auth/verify', {
            method: 'POST'
        });
        
        if (result.success) {
            currentUser = result.user;
            // 初始化并刷新AI使用显示，确保个人主页统计卡片显示正确
            initializeAIUsageData();
            updateAIUsageDisplay();
            return result;
        }
    } catch (error) {
        // 令牌验证失败，清除本地存储
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        authToken = null;
        currentUser = null;
        throw error;
    }
}

function logoutUser() {
    // 登出时停止同步
    stopSyncAfterLogout();
    
    currentUser = null;
    authToken = null;
    localStorage.removeItem('authToken');
    localStorage.removeItem('currentUser');
    
    // 更新界面
    updateLoginUI(false);
    
    // 显示退出成功消息
    customAlert('已成功退出登录');
}

function showChangePassword() {
    // 显示修改密码提示
    customAlert('修改密码功能待开发，请联系客服协助修改密码');
}

// AI使用次数管理
function initializeAIUsageData() {
    if (!currentUser) return;
    
    const today = new Date().toDateString();
    const monthKey = new Date().toISOString().slice(0,7); // YYYY-MM
    const aiUsageKey = `aiUsage_${currentUser.id}`;
    let aiUsageData = JSON.parse(localStorage.getItem(aiUsageKey) || '{}');
    
    // 初始化结构，支持每日与每月计数
    if (!aiUsageData) aiUsageData = {};
    if (aiUsageData.lastResetDate !== today) {
        aiUsageData.lastResetDate = today;
        aiUsageData.dailyUsed = 0;
    }
    if (aiUsageData.lastResetMonth !== monthKey) {
        aiUsageData.lastResetMonth = monthKey;
        aiUsageData.monthlyUsed = 0;
    }
    aiUsageData.totalUsed = aiUsageData.totalUsed || 0;
    localStorage.setItem(aiUsageKey, JSON.stringify(aiUsageData));
    
    // 同步一次服务端状态，保证显示与限制一致
    syncAIUsageFromServer();
}

function getUserType() {
    // 根据后端返回的会员信息判断用户类型
    if (!currentUser) return 'free';
    const membership = currentUser.membership;
    if (membership && membership.tier) {
        // 会员未设置到期时间或尚未到期，视为有效
        const notExpired = !membership.expiresAt || new Date(membership.expiresAt) > new Date();
        if (notExpired) {
            return String(membership.tier).toLowerCase(); // "Plus" -> "plus", "Pro" -> "pro"
        }
    }
    return 'free';
}

function getAIUsageData() {
    if (!currentUser) return null;
    
    const aiUsageKey = `aiUsage_${currentUser.id}`;
    return JSON.parse(localStorage.getItem(aiUsageKey) || '{}');
}

async function updateAIUsageData(increment = 1) {
    if (!currentUser) return false;
    try {
        const res = await fetch('http://113.44.130.103:80/api/ai/consume', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: currentUser.id })
        });
        
        // 🔒 安全检查：处理HTTP错误状态码
        if (!res.ok) {
            const errorData = await res.json().catch(() => ({}));
            const errorMessage = errorData.message || errorData.error || 'AI使用次数已达上限';
            console.warn(`[AI_QUOTA] 请求被拒绝 - Status: ${res.status}, Message: ${errorMessage}`);
            customAlert(errorMessage);
            return false;
        }
        
        const data = await res.json();
        
        // 🔒 双重验证：检查响应数据
        if (!data.success || data.allowed === false) {
            console.warn(`[AI_QUOTA] 使用次数验证失败 - Success: ${data.success}, Allowed: ${data.allowed}`);
            customAlert(data.message || 'AI使用次数已达上限');
            return false;
        }
        
        // 同步本地计数，便于显示
        const aiUsageKey = `aiUsage_${currentUser.id}`;
        const aiUsageData = {
            lastResetDate: data.usage?.lastResetDate,
            dailyUsed: data.usage?.dailyUsed || 0,
            lastResetMonth: data.usage?.lastResetMonth,
            monthlyUsed: data.usage?.monthlyUsed || 0,
            totalUsed: data.usage?.totalUsed || 0
        };
        localStorage.setItem(aiUsageKey, JSON.stringify(aiUsageData));
        updateAIUsageDisplay();
        
        console.log(`[AI_QUOTA] 使用次数验证通过 - 用户: ${currentUser.id}, 剩余: 日${data.remaining?.daily || '∞'}/月${data.remaining?.monthly || '∞'}`);
        return true;
    } catch (err) {
        console.error('[AI_QUOTA] AI配额校验失败', err);
        customAlert('AI服务繁忙，请稍后重试');
        return false;
    }
}

// 检查AI功能是否可用（次数是否足够）
function checkAIQuotaAvailable() {
    if (!currentUser) return false;
    
    const userType = getUserType();
    const aiUsageData = getAIUsageData();
    
    if (userType === 'pro') {
        return true;
    } else if (userType === 'plus') {
        const remaining = Math.max(0, 150 - (aiUsageData.monthlyUsed || 0));
        return remaining > 0;
    } else {
        const remaining = Math.max(0, 1 - (aiUsageData.dailyUsed || 0));
        return remaining > 0;
    }
}

// 检查AI按钮是否被禁用
function isAIButtonDisabled(buttonId) {
    const btn = document.getElementById(buttonId);
    // 全局处理中时，任何AI按钮都视为禁用
    return (typeof isAIProcessing !== 'undefined' && isAIProcessing) || (btn && (btn.disabled || btn.classList.contains('ai-disabled')));
}

// 全局AI处理中标记与统一禁用/恢复函数
let isAIProcessing = false;
function setAIBusyState(isBusy) {
  isAIProcessing = !!isBusy;
  const aiOptimizeBtn = document.getElementById('aiOptimizeBtn');
  const aiTranslateBtn = document.getElementById('aiTranslateBtn');
  const aiAssistantBtn = document.getElementById('aiAssistantBtn');
  const aiSubmitBtn = document.getElementById('aiSubmitBtn');
  const autoCompleteToggleBtn = document.getElementById('autoCompleteToggleBtn');
  const markdownBtn = document.getElementById('markdownBtn');

  const aiButtons = [aiOptimizeBtn, aiTranslateBtn, aiAssistantBtn, aiSubmitBtn, autoCompleteToggleBtn, markdownBtn];
  aiButtons.forEach(btn => {
    if (!btn) return;
    btn.disabled = isBusy;
    btn.classList.toggle('ai-disabled', isBusy);
    if (isBusy) {
      btn.title = 'AI正在处理，请稍候';
    }
  });
}

function updateAIUsageDisplay() {
    const aiRemainingElement = document.getElementById('aiRemainingCount');
    if (!aiRemainingElement || !currentUser) return;
    
    const userType = getUserType();
    const aiUsageData = getAIUsageData();
    
    // 获取所有AI功能按钮
    const aiOptimizeBtn = document.getElementById('aiOptimizeBtn');
    const aiTranslateBtn = document.getElementById('aiTranslateBtn');
    const aiAssistantBtn = document.getElementById('aiAssistantBtn');
    const aiSubmitBtn = document.getElementById('aiSubmitBtn');
    const autoCompleteToggleBtn = document.getElementById('autoCompleteToggleBtn');
    
    let remaining = 0;
    let hasQuota = true;
    
    if (userType === 'pro') {
        aiRemainingElement.textContent = '♾️';
        hasQuota = true;
    } else if (userType === 'plus') {
        remaining = Math.max(0, 150 - (aiUsageData.monthlyUsed || 0));
        aiRemainingElement.textContent = remaining;
        hasQuota = remaining > 0;
    } else {
        remaining = Math.max(0, 1 - (aiUsageData.dailyUsed || 0));
        aiRemainingElement.textContent = remaining;
        hasQuota = remaining > 0;
    }
    
    // 根据剩余次数控制按钮状态
    const aiButtons = [aiOptimizeBtn, aiTranslateBtn, aiAssistantBtn, aiSubmitBtn, autoCompleteToggleBtn, markdownBtn];
    aiButtons.forEach(btn => {
        if (btn) {
            if (!hasQuota) {
                // 次数用尽，禁用按钮
                btn.disabled = true;
                btn.style.opacity = '0.4';
                btn.style.cursor = 'not-allowed';
                btn.title = '今日AI次数已用完，请明天再试或升级会员';
                btn.classList.add('ai-disabled');
            } else {
                // 有次数，启用按钮
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.classList.remove('ai-disabled');
                // 恢复原始title
                if (btn.id === 'aiOptimizeBtn') {
                    btn.title = 'AI优化笔记';
                } else if (btn.id === 'aiTranslateBtn') {
                    btn.title = 'AI翻译';
                } else if (btn.id === 'aiAssistantBtn') {
                    btn.title = 'AI智能助手';
                } else if (btn.id === 'aiSubmitBtn') {
                    btn.title = '发送';
                } else if (btn.id === 'autoCompleteToggleBtn') {
                    btn.title = '自动补全开关';
                } else if (btn.id === 'markdownBtn') {
                    btn.title = 'Markdown转换';
                }
            }
        }
    });
}

async function syncAIUsageFromServer() {
    if (!currentUser) return;
    try {
        const res = await fetch(`http://113.44.130.103:80/api/ai/status/${currentUser.id}`);
        const data = await res.json();
        if (!data.success) return;
        const aiUsageKey = `aiUsage_${currentUser.id}`;
        const aiUsageData = {
            lastResetDate: data.usage?.lastResetDate,
            dailyUsed: data.usage?.dailyUsed || 0,
            lastResetMonth: data.usage?.lastResetMonth,
            monthlyUsed: data.usage?.monthlyUsed || 0,
            totalUsed: data.usage?.totalUsed || 0
        };
        localStorage.setItem(aiUsageKey, JSON.stringify(aiUsageData));
        updateAIUsageDisplay();
    } catch (err) {
        console.warn('同步AI使用状态失败', err);
    }
}

// 云同步相关功能
let syncTimer = null;
let lastSyncTime = null;
const SYNC_INTERVAL = 60000; // 1分钟同步一次

// 同步笔记到云端
async function syncNotesToCloud() {
    if (!isUserLoggedIn()) {
        console.log('用户未登录，跳过云同步');
        return;
    }
    
    try {
        // 获取本地笔记，过滤掉示例笔记
        const notesToSync = notes.filter(note => 
            !note.title.includes('欢迎使用 Notes（示例）') && 
            !note.title.includes('Welcome to Notes (Demo)')
        );
        
        const result = await apiRequest('/notes/sync', {
            method: 'POST',
            body: JSON.stringify({ notes: notesToSync })
        });
        
        if (result.success) {
            lastSyncTime = new Date();
            console.log('云同步成功:', result.syncResults);
            
            // 更新状态显示
            updateSyncStatus('同步成功', 'success');
            
            // 更新配额信息
            updateQuotaInfo(result.quota);
            
            return result;
        }
    } catch (error) {
        console.error('云同步失败:', error);
        updateSyncStatus('同步失败', 'error');
        throw error;
    }
}

// 从云端下载笔记
async function downloadNotesFromCloud() {
    if (!isUserLoggedIn()) {
        console.log('用户未登录，跳过下载');
        return;
    }
    
    try {
        const result = await apiRequest('/notes');
        
        if (result.success && result.notes.length > 0) {
            // 合并云端笔记到本地
            const cloudNotes = result.notes;
            const localNoteIds = notes.map(note => note.id);
            
            cloudNotes.forEach(cloudNote => {
                const existingIndex = notes.findIndex(note => note.id === cloudNote.id);
                
                if (existingIndex !== -1) {
                    // 如果云端版本更新，则更新本地笔记
                    if (new Date(cloudNote.updatedAt) > new Date(notes[existingIndex].updatedAt)) {
                        notes[existingIndex] = { ...cloudNote };
                    }
                } else {
                    // 新增云端笔记到本地
                    notes.push({ ...cloudNote });
                }
            });
            
            // 保存到本地存储
            saveNotesToStorage();
            renderNotesList();
            
            console.log('从云端下载笔记成功:', result.notes.length);
            return result;
        }
    } catch (error) {
        console.error('下载云端笔记失败:', error);
        throw error;
    }
}

// 获取用户配额信息
async function getUserQuota() {
    if (!isUserLoggedIn()) {
        return null;
    }
    
    try {
        const result = await apiRequest('/notes/quota');
        
        if (result.success) {
            updateQuotaInfo(result.quota);
            return result.quota;
        }
    } catch (error) {
        console.error('获取配额信息失败:', error);
        throw error;
    }
}

// 云上传功能 - 立即同步所有笔记到云端
async function uploadToCloud() {
    if (!isUserLoggedIn()) {
        customAlert('请先登录后再使用云上传功能', '提示');
        return;
    }
    
    // 检查是否有笔记需要上传
    const notesToUpload = notes.filter(note => 
        !note.title.includes('欢迎使用 Notes（示例）') && 
        !note.title.includes('Welcome to Notes (Demo)')
    );
    
    if (notesToUpload.length === 0) {
        customAlert('没有笔记需要上传', '提示');
        return;
    }
    
    // 显示上传进度提示
    const uploadBtn = document.querySelector('.cloud-upload-btn');
    const originalText = uploadBtn.innerHTML;
    uploadBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
        </svg>
        上传中...
    `;
    uploadBtn.disabled = true;
    
    try {
        // 调用同步函数
        const result = await syncNotesToCloud();
        
        if (result && result.success) {
            customAlert(`成功上传 ${notesToUpload.length} 条笔记到云端！`, '上传成功');
            
            // 更新按钮状态为成功
            uploadBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 6L9 17l-5-5"></path>
                </svg>
                上传成功
            `;
            
            // 2秒后恢复原始状态
            setTimeout(() => {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            }, 2000);
        }
    } catch (error) {
        console.error('云上传失败:', error);
        customAlert('云上传失败，请检查网络连接后重试', '上传失败');
        
        // 恢复按钮状态
        uploadBtn.innerHTML = originalText;
        uploadBtn.disabled = false;
    }
}

// 更新同步状态显示
function updateSyncStatus(message, type = 'info') {
    const statusEl = document.getElementById('status');
    if (statusEl) {
        const originalText = statusEl.textContent;
        const syncIndicator = document.createElement('span');
        syncIndicator.className = `sync-status sync-status--${type}`;
        syncIndicator.textContent = ` • ${message}`;
        
        // 移除现有的同步状态
        const existingSyncStatus = statusEl.querySelector('.sync-status');
        if (existingSyncStatus) {
            existingSyncStatus.remove();
        }
        
        statusEl.appendChild(syncIndicator);
        
        // 3秒后恢复原始状态
        setTimeout(() => {
            if (syncIndicator.parentNode === statusEl) {
                syncIndicator.remove();
            }
        }, 3000);
    }
}

// 更新配额信息显示
function updateQuotaInfo(quota) {
    if (!quota) return;
    
    const usedMB = (quota.usedSpace / (1024 * 1024)).toFixed(2);
    const totalMB = (quota.totalSpace / (1024 * 1024)).toFixed(0);
    const remainingMB = (quota.remainingSpace / (1024 * 1024)).toFixed(2);
    
    console.log(`云空间使用情况: ${usedMB}MB / ${totalMB}MB (剩余 ${remainingMB}MB)`);
    
    // 可以在这里添加配额显示到界面的逻辑
    // 例如在状态栏显示空间使用情况
}

// 启动自动同步
function startAutoSync() {
    if (syncTimer) {
        clearInterval(syncTimer);
    }
    
    // 立即执行一次同步
    syncNotesToCloud().catch(console.error);
    
    // 设置定时同步
    syncTimer = setInterval(() => {
        syncNotesToCloud().catch(console.error);
    }, SYNC_INTERVAL);
}

// 停止自动同步
function stopAutoSync() {
    if (syncTimer) {
        clearInterval(syncTimer);
        syncTimer = null;
    }
}

// 登录后初始化同步
function initializeSyncAfterLogin() {
    // 下载云端笔记
    downloadNotesFromCloud().then(() => {
        // 启动自动同步
        startAutoSync();
        
        // 获取配额信息
        getUserQuota().catch(console.error);
    }).catch(console.error);
}

// 登出时停止同步
function stopSyncAfterLogout() {
    stopAutoSync();
    lastSyncTime = null;
}

// 初始化用户状态
async function initializeUser() {
    if (authToken) {
        try {
            await verifyToken();
            updateLoginUI(true);
            // 登录后初始化同步
            initializeSyncAfterLogin();
        } catch (error) {
            updateLoginUI(false);
        }
    } else {
        updateLoginUI(false);
    }
}

// 检查用户是否已登录
function isUserLoggedIn() {
    return !!(currentUser && authToken);
}

// 显示未登录提示弹窗
function showLoginRequiredPopup() {
    const popup = document.createElement('div');
    popup.className = 'login-required-popup';
    popup.innerHTML = `
        <div class="login-required-backdrop"></div>
        <div class="login-required-content">
            <div class="login-required-icon">
                <i class="fi fi-bs-user" style="font-size: 48px; color: #4da6ff;"></i>
            </div>
            <h3 class="login-required-title">需要登录</h3>
            <p class="login-required-message">使用AI功能需要先登录您的账户</p>
            <div class="login-required-buttons">
                <button class="login-required-btn login-required-btn--primary" id="loginRequiredBtn">
                    <span>立即登录</span>
                </button>
                <button class="login-required-btn login-required-btn--secondary" id="cancelRequiredBtn">
                    <span>稍后再说</span>
                </button>
            </div>
        </div>
    `;
    
    // 添加到页面
    document.body.appendChild(popup);
    
    // 添加样式
    if (!document.querySelector('#loginRequiredStyles')) {
        const style = document.createElement('style');
        style.id = 'loginRequiredStyles';
        style.textContent = `
            .login-required-popup {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: loginRequiredFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .login-required-backdrop {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                backdrop-filter: blur(8px);
            }
            
            .login-required-content {
                position: relative;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(20px);
                padding: 32px;
                border-radius: 20px;
                text-align: center;
                max-width: 360px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.2);
                animation: loginRequiredScaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                transform-origin: center;
            }
            
            .login-required-icon {
                margin-bottom: 20px;
            }
            
            .login-required-icon svg {
                filter: drop-shadow(0 4px 12px rgba(77, 166, 255, 0.3));
            }
            
            .login-required-title {
                margin: 0 0 12px 0;
                color: #333;
                font-size: 22px;
                font-weight: 600;
                background: linear-gradient(135deg, #4da6ff, #3399ff);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            .login-required-message {
                margin: 0 0 28px 0;
                color: #666;
                font-size: 15px;
                line-height: 1.5;
            }
            
            .login-required-buttons {
                display: flex;
                gap: 12px;
                justify-content: center;
            }
            
            .login-required-btn {
                padding: 12px 24px;
                border: none;
                border-radius: 12px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
            }
            
            .login-required-btn span {
                position: relative;
                z-index: 2;
            }
            
            .login-required-btn--primary {
                background: linear-gradient(135deg, #4da6ff, #3399ff);
                color: white;
                box-shadow: 0 4px 16px rgba(77, 166, 255, 0.3);
            }
            
            .login-required-btn--primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 24px rgba(77, 166, 255, 0.4);
            }
            
            .login-required-btn--primary:active {
                transform: translateY(0);
                box-shadow: 0 2px 8px rgba(77, 166, 255, 0.2);
            }
            
            .login-required-btn--secondary {
                background: rgba(255, 255, 255, 0.8);
                color: #666;
                border: 1px solid rgba(0, 0, 0, 0.06);
                backdrop-filter: blur(10px);
            }
            
            .login-required-btn--secondary:hover {
                background: rgba(77, 166, 255, 0.1);
                color: #4da6ff;
                border-color: rgba(77, 166, 255, 0.3);
                transform: translateY(-1px);
            }
            
            @keyframes loginRequiredFadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes loginRequiredScaleIn {
                from { 
                    transform: scale(0.8); 
                    opacity: 0; 
                }
                to { 
                    transform: scale(1); 
                    opacity: 1; 
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    // 事件处理
    document.getElementById('loginRequiredBtn').addEventListener('click', () => {
        document.body.removeChild(popup);
        // 显示登录页面
        document.getElementById('loginPage').style.display = 'block';
        initializeUser();
    });
    
    document.getElementById('cancelRequiredBtn').addEventListener('click', () => {
        document.body.removeChild(popup);
    });
    
    // 点击背景关闭
    popup.addEventListener('click', (e) => {
        if (e.target === popup) {
            document.body.removeChild(popup);
        }
    });
}

// 更新AI功能按钮状态
function updateAIFeatureButtons() {
    const isLoggedIn = isUserLoggedIn();
    const aiOptimizeBtn = document.getElementById('aiOptimizeBtn');
    const aiAssistantBtn = document.getElementById('aiAssistantBtn');
    const autoCompleteToggleBtn = document.getElementById('autoCompleteToggleBtn');
    const markdownBtn = document.getElementById('markdownBtn');
    
    // 让按钮可以点击，但添加视觉提示
    if (aiOptimizeBtn) {
        aiOptimizeBtn.disabled = false; // 允许点击
        aiOptimizeBtn.style.opacity = isLoggedIn ? '1' : '0.7';
        aiOptimizeBtn.style.cursor = 'pointer';
        aiOptimizeBtn.title = isLoggedIn ? getText('ai-optimize') : getText('ai-optimize') + ' (需要登录)';
    }
    
    if (aiAssistantBtn) {
        aiAssistantBtn.disabled = false; // 允许点击
        aiAssistantBtn.style.opacity = isLoggedIn ? '1' : '0.7';
        aiAssistantBtn.style.cursor = 'pointer';
        aiAssistantBtn.title = isLoggedIn ? getText('ai-assistant') : getText('ai-assistant') + ' (需要登录)';
    }
    
    if (autoCompleteToggleBtn) {
        autoCompleteToggleBtn.disabled = false; // 允许点击
        autoCompleteToggleBtn.style.opacity = isLoggedIn ? '1' : '0.7';
        autoCompleteToggleBtn.style.cursor = 'pointer';
        autoCompleteToggleBtn.title = isLoggedIn ? getText('autocomplete-toggle') : getText('autocomplete-toggle') + ' (需要登录)';
        
        // 如果未登录且自动补全已开启，则关闭它
        if (!isLoggedIn && autoCompleteEnabled) {
            autoCompleteEnabled = false;
            autoCompleteToggleBtn.setAttribute('data-enabled', 'false');
            hideAutoComplete();
        }
    }
    
    if (markdownBtn) {
        markdownBtn.disabled = false; // 允许点击
        markdownBtn.style.opacity = isLoggedIn ? '1' : '0.7';
        markdownBtn.style.cursor = 'pointer';
        markdownBtn.title = isLoggedIn ? getText('markdown-convert') : getText('markdown-convert') + ' (需要登录)';
    }
}

// 检查登录状态的AI功能包装器
function requireLoginForAIFeature(callback) {
    if (!isUserLoggedIn()) {
        showLoginRequiredPopup();
        return false;
    }
    
    if (typeof callback === 'function') {
        return callback();
    }
    
    return true;
}

// 更新登录界面状态
function updateLoginUI(isLoggedIn) {
    const loginPage = document.getElementById('loginPage');
    const profileBtn = document.getElementById('profileBtn');
    
    if (isLoggedIn && currentUser) {
        // 用户已登录
        profileBtn.title = `已登录: ${currentUser.username}`;
        
        // 隐藏登录页面
        if (loginPage.style.display === 'block') {
            loginPage.style.display = 'none';
        }
    } else {
        // 用户未登录
        profileBtn.title = getText('profile');
    }
    
    // 更新AI功能按钮状态
    updateAIFeatureButtons();
}

// 退出登录函数已在上方定义，此处删除重复定义

// 格式化日期函数
function formatDate(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}`;
}

// 登录/注册表单切换
function setupAuthForms() {
    const loginTab = document.getElementById('loginTab');
    const registerTab = document.getElementById('registerTab');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    
    // 登录标签点击事件
    loginTab.addEventListener('click', () => {
        loginTab.classList.add('active');
        registerTab.classList.remove('active');
        loginForm.classList.add('active');
        registerForm.classList.remove('active');
    });
    
    // 注册标签点击事件
    registerTab.addEventListener('click', () => {
        registerTab.classList.add('active');
        loginTab.classList.remove('active');
        registerForm.classList.add('active');
        loginForm.classList.remove('active');
    });
    
    // 登录按钮点击事件
    const loginBtn = document.getElementById('loginBtn');
    loginBtn.addEventListener('click', handleLogin);
    
    // 注册按钮点击事件
    const registerSubmitBtn = document.getElementById('registerSubmitBtn');
    registerSubmitBtn.addEventListener('click', handleRegister);
    
    // 发送验证码按钮点击事件
    const sendVerificationCodeBtn = document.getElementById('sendVerificationCodeBtn');
    sendVerificationCodeBtn.addEventListener('click', handleSendVerificationCode);
    
    // 登录表单回车事件
    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    
    usernameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    
    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    
    // 注册表单回车事件
    const registerUsername = document.getElementById('registerUsername');
    const registerEmail = document.getElementById('registerEmail');
    const registerPassword = document.getElementById('registerPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    
    registerUsername.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleRegister();
    });
    
    registerEmail.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleRegister();
    });
    
    registerPassword.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleRegister();
    });
}

// 处理登录
async function handleLogin() {
    const identifier = document.getElementById('usernameInput').value.trim();
    const password = document.getElementById('passwordInput').value;
    
    if (!identifier || !password) {
        alert('请输入用户名/邮箱和密码');
        return;
    }
    
    try {
        const result = await loginUser(identifier, password);
        if (result.success) {
            alert('登录成功！');
            updateLoginUI(true);
            // 清空表单
            document.getElementById('usernameInput').value = '';
            document.getElementById('passwordInput').value = '';
        }
    } catch (error) {
        alert('登录失败：' + error.message);
    }
}

// 处理注册
async function handleRegister() {
    const username = document.getElementById('registerUsername').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const verificationCode = document.getElementById('verificationCode').value.trim();
    
    // 验证输入
    if (!username || !email || !password || !verificationCode) {
        alert('请填写所有必填字段');
        return;
    }
    
    if (password.length < 6) {
        alert('密码长度至少为6位');
        return;
    }
    
    if (!isValidEmail(email)) {
        alert('请输入有效的邮箱地址');
        return;
    }
    
    if (!/^\d{6}$/.test(verificationCode)) {
        alert('验证码必须是6位数字');
        return;
    }
    
    try {
        const result = await registerUser(username, email, password, verificationCode);
        if (result.success) {
            alert('注册成功！已自动登录');
            updateLoginUI(true);
            // 切换到登录标签并清空表单
            document.getElementById('loginTab').click();
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('verificationCode').value = '';
        }
    } catch (error) {
        alert('注册失败：' + error.message);
    }
}

// 处理发送验证码
async function handleSendVerificationCode() {
    const email = document.getElementById('registerEmail').value.trim();
    
    if (!email) {
        alert('请输入邮箱地址');
        return;
    }
    
    if (!isValidEmail(email)) {
        alert('请输入有效的邮箱地址');
        return;
    }
    
    const sendBtn = document.getElementById('sendVerificationCodeBtn');
    
    try {
        sendBtn.disabled = true;
        sendBtn.textContent = '发送中...';
        
        const result = await sendVerificationCode(email);
        if (result.success) {
            alert('验证码已发送到您的邮箱，请查收');
            startCountdown(60); // 60秒倒计时
        }
    } catch (error) {
        alert('发送验证码失败：' + error.message);
        sendBtn.disabled = false;
        sendBtn.textContent = '发送验证码';
    }
}

// 倒计时函数
function startCountdown(seconds) {
    const sendBtn = document.getElementById('sendVerificationCodeBtn');
    let countdown = seconds;
    
    const timer = setInterval(() => {
        sendBtn.textContent = `重新发送(${countdown}s)`;
        sendBtn.classList.add('countdown');
        
        if (countdown <= 0) {
            clearInterval(timer);
            sendBtn.disabled = false;
            sendBtn.textContent = '发送验证码';
            sendBtn.classList.remove('countdown');
        } else {
            countdown--;
        }
    }, 1000);
}

// 邮箱验证函数
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

// 国际化文本映射
const i18nTexts = {
  'zh': {
    'app-title': 'Minimal Notes (Demo)',
    'new-note': '新建笔记',
    'search-placeholder': '搜索笔记...',
    'login-tab': '登录',
    'register-tab': '注册',
    'email-label': '邮箱',
    'email-placeholder': '请输入邮箱地址',
    'name-label': '姓名',
    'name-placeholder': '请输入姓名',

    'register-submit-btn': '注册',
    'register-agreement': '注册即表示同意我们的服务条款和隐私政策',
    'note-title-placeholder': '笔记标题',
    'note-content-placeholder': '开始写作...',
    'tags-placeholder': '标签（用逗号分隔）',
    'delete': '删除',
    'settings': '设置',
    'settings-title': '个性化设置',
    'borderless-mode': '无边际模式',
    'borderless-mode-desc': '开启后，编辑区域将没有边框，呈现更简洁的界面',
    'divider-lines': '显示分割线',
    'divider-lines-desc': '在标题和内容区域之间显示分割线',
    'liquid-glass-mode': '液态玻璃模式',
    'liquid-glass-mode-desc': '启用iOS 26风格的液态玻璃效果（当前处于Beta测试版）。',
    'english-mode': '英文版',
    'english-mode-desc': '切换界面语言为英文',
    'ai-assistant-placeholder': '向AI助手提问...',
    'ai-optimize': 'AI优化',
    'ai-translate': 'AI翻译',
    'ai-assist': 'AI助手',
    'markdown-convert': '转为Markdown',
    'auto-complete': '自动补全',
    'toggle-preview': '切换预览',
    'toggle-sidebar': '切换侧栏',
    'export': '导出',
    'export-txt': '导出TXT',
    'export-md': '导出MD',
    'import': '导入',
    'send': '发送',
    'cancel': '取消',
    'preview': '预览',
    'status-unsaved': '未保存',
    'status-saved': '已保存',
    'status-loaded': '已加载',
    'status-editing': '正在编辑…',
    'status-save-failed': '保存失败',
    'status-deleted': '已删除',
    'no-notes': '暂无笔记 — 点击"新建"开始',
    'no-title': '(无标题)',
    'ai-optimizing': 'AI正在优化笔记内容...',
    'ai-optimize-complete': 'AI优化完成',
    'ai-optimize-failed': 'AI优化失败',
    'ai-translating': 'AI正在翻译笔记内容...',
    'ai-translate-complete': 'AI翻译完成',
    'ai-translate-failed': 'AI翻译失败',
    'ai-analyzing': 'AI正在分析笔记内容...',
    'ai-analyze-complete': 'AI分析完成',
    'ai-analyze-failed': 'AI分析失败',
    'ai-converting': 'AI正在转换为Markdown格式...',
    'ai-convert-complete': 'Markdown转换完成',
    'ai-convert-failed': 'Markdown转换失败',
    'ai-processing': 'AI正在处理您的请求...',
    'ai-process-complete': 'AI处理完成',
    'ai-process-failed': 'AI处理失败',
    'ai-generating': 'AI正在生成',
    'autocomplete-enabled': '自动补全已开启',
    'autocomplete-disabled': '自动补全已关闭',
    'ai-select-note-first': '请先选择一个笔记',
    'ai-empty-content': '笔记内容为空，无法操作',
    'ai-service-not-initialized': 'AI服务未初始化',
    'ai-input-required': '请输入您的要求',
    'ai-note-not-found': '未找到当前笔记',
    'confirm-delete': '确认删除这条笔记吗？此操作无法撤销（可先导出备份）。',
    'export-format-prompt': '请选择导出格式:\n1. TXT (输入 txt)\n2. Markdown (输入 md)',
    'export-success': '已导出为',
    'import-success': '成功导入',
    'import-failed': '导入失败',
    'unsupported-format': '不支持的格式，请输入 txt 或 md',
    'welcome-title': 'Welcome to Notes (Demo)',
    'welcome-content': 'This is a minimalist note-taking app with AI features. Supports **Markdown**. Try it out:\n\n- ⌘/Ctrl+N New note\n- Auto-save note content\n- (From left to right) First button: Collapse/expand left note list\n- Second: Convert note to Markdown format\n- Third: AI optimize note format/expression\n- Fourth: Make personalized requests to AI\n- Fifth: AI auto-completion feature, try it yourself\n\n```\nconsole.log(\"hello\")\n```\nProduct is under development, does not represent final quality.\nFeedback/Suggestions: smtoffice@yeah.net',
    'ai-assistant-suggestions': 'AI助手建议',
    'ai-assistant-reply': 'AI助手回复',
    'profile': '个人资料',
    'login-title': '登录',
    'username-label': '用户名或邮箱',
    'username-placeholder': '请输入用户名或邮箱',
    'password-label': '密码',
    'password-placeholder': '请输入密码',
    'remember-me': '记住我',
    'login-btn': '登录',
    'register-btn': '注册',
    'verification-code-label': '验证码',
    'verification-code-placeholder': '请输入验证码',
    'send-verification-code-btn': '发送验证码',
    'or': '或',
    'login-with-apple': '使用 Apple ID 登录',
    'login-with-google': '使用 Google 登录',
    'forgot-password': '忘记密码？',
    'login-success': '登录成功！',
    'login-demo': '这是演示版本，无需真实登录'
  },
  'en': {
    'app-title': 'Minimal Notes (Demo)',
    'new-note': 'New Note',
    'search-placeholder': 'Search notes...',
    'note-title-placeholder': 'Note title',
    'note-content-placeholder': 'Start writing...',
    'tags-placeholder': 'Tags (comma separated)',
    'delete': 'Delete',
    'settings': 'Settings',
    'settings-title': 'Personalization Settings',
    'borderless-mode': 'Borderless Mode',
    'borderless-mode-desc': 'When enabled, the editing area will have no borders for a cleaner interface',
    'divider-lines': 'Show Divider Lines',
    'divider-lines-desc': 'Display divider lines between title and content areas',
    'liquid-glass-mode': 'Liquid Glass Mode',
    'liquid-glass-mode-desc': 'Enable iOS 26 style liquid glass effects (currently in Beta).',
    'english-mode': 'English Version',
    'english-mode-desc': 'Switch interface language to English',
    'ai-assistant-placeholder': 'Ask AI assistant...',
    'ai-optimize': 'AI Optimize',
    'ai-translate': 'AI Translate',
    'ai-assist': 'AI Assistant',
    'markdown-convert': 'Convert to Markdown',
    'auto-complete': 'Auto Complete',
    'toggle-preview': 'Toggle Preview',
    'toggle-sidebar': 'Toggle Sidebar',
    'export': 'Export',
    'import': 'Import',
    'send': 'Send',
    'cancel': 'Cancel',
    'preview': 'Preview',
    'status-unsaved': 'Unsaved',
    'status-saved': 'Saved',
    'status-loaded': 'Loaded',
    'status-editing': 'Editing...',
    'status-save-failed': 'Save failed',
    'status-deleted': 'Deleted',
    'no-notes': 'No notes yet — Click "New" to start',
    'no-title': '(Untitled)',
    'ai-optimizing': 'AI is optimizing note content...',
    'ai-optimize-complete': 'AI optimization complete',
    'ai-optimize-failed': 'AI optimization failed',
    'ai-translating': 'AI is translating note content...',
    'ai-translate-complete': 'AI translation complete',
    'ai-translate-failed': 'AI translation failed',
    'ai-analyzing': 'AI is analyzing note content...',
    'ai-analyze-complete': 'AI analysis complete',
    'ai-analyze-failed': 'AI analysis failed',
    'ai-converting': 'AI is converting to Markdown format...',
    'ai-convert-complete': 'Markdown conversion complete',
    'ai-convert-failed': 'Markdown conversion failed',
    'ai-processing': 'AI is processing your request...',
    'ai-process-complete': 'AI processing complete',
    'ai-process-failed': 'AI processing failed',
    'ai-generating': 'AI is generating',
    'autocomplete-enabled': 'Auto-completion enabled',
    'autocomplete-disabled': 'Auto-completion disabled',
    'ai-select-note-first': 'Please select a note first',
    'ai-empty-content': 'Note content is empty, cannot proceed',
    'ai-service-not-initialized': 'AI service not initialized',
    'ai-input-required': 'Please enter your request',
    'ai-note-not-found': 'Current note not found',
    'confirm-delete': 'Are you sure you want to delete this note? This action cannot be undone (you can export a backup first).',
    'export-format-prompt': 'Please select export format:\n1. TXT (enter txt)\n2. Markdown (enter md)',
    'export-success': 'Exported as',
    'import-success': 'Successfully imported',
    'import-failed': 'Import failed',
    'unsupported-format': 'Unsupported format, please enter txt or md',
    'welcome-title': 'Welcome to Notes (Demo)',
    'welcome-content': 'This is a minimalist note-taking app with AI features. Supports **Markdown**. Try it out:\n\n- ⌘/Ctrl+N New note\n- Auto-save note content\n- (From left to right) First button: Collapse/expand left note list\n- Second: Convert note to Markdown format\n- Third: AI optimize note format/expression\n- Fourth: Make personalized requests to AI\n- Fifth: AI auto-completion feature, try it yourself\n\n```\nconsole.log(\"hello\")\n```\nProduct is under development, does not represent final quality.\nFeedback/Suggestions: smtoffice@yeah.net',
    'ai-assistant-suggestions': 'AI Assistant Suggestions',
    'ai-assistant-reply': 'AI Assistant Reply',
    'profile': 'Profile',
    'login-title': 'Login',
    'username-label': 'Username or Email',
    'username-placeholder': 'Enter username or email',
    'password-label': 'Password',
    'password-placeholder': 'Enter password',
    'remember-me': 'Remember me',
    'login-btn': 'Login',
    'register-btn': 'Register',
    'or': 'or',
    'login-with-apple': 'Sign in with Apple ID',
    'login-with-google': 'Sign in with Google',
    'forgot-password': 'Forgot password?',
    'login-success': 'Login successful!',
    'login-demo': 'This is a demo version, no real login required'
  }
};

// 当前语言
let currentLanguage = 'zh';

const STORAGE_KEY = 'minimal_notes_v1';
const AUTO_SAVE_DEBOUNCE = 700;

let notes = [];
let currentId = null;
let saveTimer = null;
let previewVisible = false;
let sidebarVisible = true;
let autoCompleteEnabled = false; // 自动补全开关状态，默认关闭

/* helpers */
const uid = () => 'n_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
const nowISO = () => new Date().toISOString();

function loadNotesFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    notes = raw ? JSON.parse(raw) : [];
  } catch(e) {
    console.error('loadNotesFromStorage error', e);
    notes = [];
  }
}
function saveNotesToStorage(){
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
    updateStatus(getText('status-saved') + ' • ' + new Date().toLocaleTimeString());
  } catch(e) {
    console.error('saveNotesToStorage error', e);
    updateStatus(getText('status-save-failed'));
  }
}

/* UI refs */
const notesList = document.getElementById('notesList');
const newNoteBtn = document.getElementById('newNoteBtn');
const noteTitle = document.getElementById('noteTitle');
const noteBody = document.getElementById('noteBody');
const statusEl = document.getElementById('status');
const previewEl = document.getElementById('preview');
const togglePreviewBtn = document.getElementById('togglePreview');
const exportBtn = document.getElementById('exportBtn');
const exportDialog = document.getElementById('exportDialog');
const exportTxtOption = document.getElementById('exportTxtOption');
const exportMdOption = document.getElementById('exportMdOption');
const exportCancelBtn = document.getElementById('exportCancelBtn');
const importBtn = document.getElementById('importBtn');
const deleteBtn = document.getElementById('deleteBtn');
const searchInput = document.getElementById('searchInput');
const hiddenFileInput = document.getElementById('hiddenFileInput');
const settingsBtn = document.getElementById('settingsBtn');
const settingsPage = document.getElementById('settingsPage');
const closeSettingsBtn = document.getElementById('closeSettingsBtn');
const borderlessToggle = document.getElementById('borderlessToggle');
const dividerToggle = document.getElementById('dividerToggle');
const noteTags = document.getElementById('noteTags');
const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
const markdownBtn = document.getElementById('markdownBtn');
const sidebar = document.querySelector('.sidebar');
const aiOptimizeBtn = document.getElementById('aiOptimizeBtn');
const aiAssistantBtn = document.getElementById('aiAssistantBtn');
const aiInputContainer = document.getElementById('aiInputContainer');
const aiCustomInput = document.getElementById('aiCustomInput');
const aiSubmitBtn = document.getElementById('aiSubmitBtn');
const aiCancelBtn = document.getElementById('aiCancelBtn');
const autoCompleteOverlay = document.getElementById('autoComplete');

// 自动补全相关变量
let autoCompleteTimeout = null;
let currentSuggestion = '';
let isAutoCompleteActive = false;

function renderNotesList(filter=''){
  notesList.innerHTML = '';
  const q = filter.trim().toLowerCase();
  const ordered = notes.slice().sort((a,b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt));
  for (const n of ordered) {
    if (q && !(n.title + ' ' + n.content).toLowerCase().includes(q)) continue;
    const item = document.createElement('div');
    item.className = 'note-item' + (n.id===currentId ? ' active' : '');
    item.tabIndex = 0;
    item.setAttribute('role','listitem');
    item.innerHTML = `
      <div style="flex:1">
        <div class="note-title">${escapeHtml((n.title || '').slice(0,80)) || getText('no-title')}</div>
        <div class="note-excerpt">${escapeHtml((n.content || '').replace(/\n/g,' ').slice(0,160))}</div>
        <div class="meta">${new Date(n.updatedAt || n.createdAt).toLocaleString()}</div>
      </div>
    `;
    item.addEventListener('click', () => selectNote(n.id));
    item.addEventListener('keydown', (e) => { if (e.key==='Enter') selectNote(n.id); });
    notesList.appendChild(item);
  }

  if (!notesList.childElementCount) {
    notesList.innerHTML = `<div style="padding:12px;color:#8a8a8a">${getText('no-notes')}</div>`;
  }
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
}

function selectNote(id){
  const n = notes.find(x=>x.id===id);
  if (!n) return;
  currentId = id;
  noteTitle.value = n.title || '';
  noteBody.value = n.content || '';
  renderNotesList(searchInput.value);
  renderPreview();
  renderTags(n.tags || []);
  updateStatus('status-loaded', true);
}

function renderTags(tags){
  noteTags.innerHTML = '';
  (tags||[]).forEach(t=>{
    const el = document.createElement('div');
    el.className = 'tag';
    el.textContent = t;
    noteTags.appendChild(el);
  });
}

function newNote(){
  const id = uid();
  const n = { id, title: '', content: '', tags: [], createdAt: nowISO(), updatedAt: nowISO() };
  notes.push(n);
  currentId = id;
  renderNotesList(searchInput.value);
  selectNote(id);
  scheduleSaveImmediate();
  noteTitle.focus();
}

function scheduleSave(){
  updateStatus('status-editing', true);
  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(() => performSave(), AUTO_SAVE_DEBOUNCE);
}

function scheduleSaveImmediate(){
  if (saveTimer) { clearTimeout(saveTimer); saveTimer = null; }
  performSave();
}

function performSave(){
  if (!currentId) return;
  const n = notes.find(x=>x.id===currentId);
  if (!n) return;
  n.title = noteTitle.value.trim();
  n.content = noteBody.value;
  n.updatedAt = nowISO();
  saveNotesToStorage();
  renderNotesList(searchInput.value);
  renderPreview();
}

function updateStatus(txt, isI18nKey = false){
  if (isI18nKey) {
    statusEl.textContent = getText(txt);
    statusEl.setAttribute('data-i18n', txt);
  } else {
    statusEl.textContent = txt;
    statusEl.removeAttribute('data-i18n');
  }
}

/* Toggle sidebar visibility */
function toggleSidebar(){
  sidebarVisible = !sidebarVisible;
  if (sidebarVisible) {
    sidebar.style.width = '300px';
    sidebar.style.opacity = '1';
    sidebar.style.padding = '12px';
  } else {
    sidebar.style.width = '0';
    sidebar.style.opacity = '0';
    sidebar.style.padding = '0';
  }
}

/* AI optimization functions */
async function optimizeNoteWithAI() {
  if (!currentId) {
    updateStatus(getText('ai-select-note-first'));
    return;
  }
  
  const currentNote = notes.find(n => n.id === currentId);
  if (!currentNote || !currentNote.content.trim()) {
    updateStatus(getText('ai-empty-content'));
    return;
  }
  
  updateStatus('ai-optimizing', true);
  aiOptimizeBtn.disabled = true;
  setAIBusyState(true);
  
  // 🔒 安全检查：先验证AI使用次数，再执行AI请求
  const hasQuota = await updateAIUsageData();
  if (!hasQuota) {
    aiOptimizeBtn.disabled = false;
    setAIBusyState(false);
    return;
  }
  
  // 设置AI响应回调
  if (window.sparkAPI) {
    let accumulatedResponse = ''; // 累积流式响应内容
    
    window.sparkAPI.setResponseCallback((response, type, isComplete) => {
      if (type === 'error') {
        updateStatus(getText('ai-optimize-failed') + ': ' + response);
        aiOptimizeBtn.disabled = false;
        setAIBusyState(false);
        return;
      }
      
      if (type === 'assistant') {
        // 累积流式响应内容
        if (response) {
          accumulatedResponse += response;
        }
        
        // 实时更新笔记内容
        noteBody.value = accumulatedResponse;
        renderPreview();
        
        if (isComplete) {
          // 优化完成，保存笔记
          performSave();
          updateStatus('ai-optimize-complete', true);
          aiOptimizeBtn.disabled = false;
          setAIBusyState(false);
          accumulatedResponse = ''; // 重置累积内容
        } else {
          updateStatus(getText('ai-generating') + '...');
        }
      }
    });
    
    // 发送优化请求
    const optimizePrompt = `请帮我优化以下笔记内容，使其更清晰、有条理且易读。优化时需保持原有核心信息与含义不变，可改进表达方式、调整结构。保持原语言。仅返回最终优化后的笔记，无需附加其他无关内容：

${currentNote.content}`;
    
    window.sparkAPI.sendMessage(optimizePrompt);
  } else {
    updateStatus('ai-service-not-initialized', true);
    aiOptimizeBtn.disabled = false;
    setAIBusyState(false);
  }
}

async function translateNoteWithAI() {
  if (!currentId) {
    updateStatus(getText('ai-select-note-first'));
    return;
  }
  
  const currentNote = notes.find(n => n.id === currentId);
  if (!currentNote || !currentNote.content.trim()) {
    updateStatus(getText('ai-empty-content'));
    return;
  }
  
  updateStatus('ai-translating', true);
  aiTranslateBtn.disabled = true;
  setAIBusyState(true);
  
  // 🔒 安全检查：先验证AI使用次数，再执行AI请求
  const hasQuota = await updateAIUsageData();
  if (!hasQuota) {
    aiTranslateBtn.disabled = false;
    setAIBusyState(false);
    return;
  }
  
  // 设置AI响应回调
  if (window.sparkAPI) {
    let accumulatedResponse = ''; // 累积流式响应内容
    
    window.sparkAPI.setResponseCallback((response, type, isComplete) => {
      if (type === 'error') {
        updateStatus(getText('ai-translate-failed') + ': ' + response);
        aiTranslateBtn.disabled = false;
        setAIBusyState(false);
        return;
      }
      
      if (type === 'assistant') {
        // 累积流式响应内容
        if (response) {
          accumulatedResponse += response;
        }
        
        // 实时更新笔记内容
        noteBody.value = accumulatedResponse;
        renderPreview();
        
        if (isComplete) {
          // 翻译完成，保存笔记
          performSave();
          updateStatus('ai-translate-complete', true);
          aiTranslateBtn.disabled = false;
          accumulatedResponse = ''; // 重置累积内容
        } else {
          updateStatus(getText('ai-translating') + '...');
        }
      }
    });
    
    // 检测当前内容语言并决定翻译方向
    const content = currentNote.content;
    const isChinese = /[\u4e00-\u9fff]/.test(content);
    const isEnglish = /[a-zA-Z]/.test(content);
    
    let translatePrompt;
    if (isChinese && !isEnglish) {
      // 中文内容翻译为英文
      translatePrompt = `请将以下中文内容翻译成英文。保持原有的格式和结构，确保翻译准确自然。仅返回翻译后的英文内容，无需附加其他说明：

${content}`;
    } else if (isEnglish && !isChinese) {
      // 英文内容翻译为中文
      translatePrompt = `请将以下英文内容翻译成中文。保持原有的格式和结构，确保翻译准确自然。仅返回翻译后的中文内容，无需附加其他说明：

${content}`;
    } else {
      // 混合内容或无法确定语言，默认中英互译
      translatePrompt = `请智能翻译以下内容。如果主要是中文，请翻译成英文；如果主要是英文，请翻译成中文。保持原有的格式和结构，确保翻译准确自然。仅返回翻译后的内容，无需附加其他说明：

${content}`;
    }
    
    window.sparkAPI.sendMessage(translatePrompt);
  } else {
    updateStatus('ai-service-not-initialized', true);
    aiTranslateBtn.disabled = false;
  }
}

async function assistWithAI() {
  if (!currentId) {
    updateStatus('请先选择一个笔记');
    return;
  }
  
  const currentNote = notes.find(n => n.id === currentId);
  if (!currentNote || !currentNote.content.trim()) {
    updateStatus(getText('ai-empty-content'));
    return;
  }
  
  updateStatus('AI正在分析笔记内容...');
  aiAssistantBtn.disabled = true;
  
  // 🔒 安全检查：先验证AI使用次数，再执行AI请求
  const hasQuota = await updateAIUsageData();
  if (!hasQuota) {
    aiAssistantBtn.disabled = false;
    return;
  }
  
  // 设置AI响应回调
  if (window.sparkAPI) {
    let accumulatedResponse = ''; // 累积流式响应内容
    
    window.sparkAPI.setResponseCallback((response, type, isComplete) => {
      if (type === 'error') {
        updateStatus(getText('ai-analyze-failed') + ': ' + response);
        aiAssistantBtn.disabled = false;
        return;
      }
      
      if (type === 'assistant') {
        // 累积流式响应内容
        if (response) {
          accumulatedResponse += response;
        }
        
        // 实时更新笔记内容，在原内容后添加AI建议
        const separator = `\n\n---\n\n**${getText('ai-assistant-suggestions')}：**\n\n`;
        const originalContent = currentNote.content;
        
        // 检查是否已经有AI建议部分
        const aiSuggestionIndex = originalContent.indexOf(`---\n\n**${getText('ai-assistant-suggestions')}：**`);
        let baseContent = aiSuggestionIndex !== -1 ? 
          originalContent.substring(0, aiSuggestionIndex).trim() : 
          originalContent;
        
        noteBody.value = baseContent + separator + accumulatedResponse;
        renderPreview();
        
        if (isComplete) {
          // 分析完成，保存笔记
          performSave();
          updateStatus(getText('ai-analyze-complete'));
          aiAssistantBtn.disabled = false;
          setAIBusyState(false);
          accumulatedResponse = ''; // 重置累积内容
        } else {
          updateStatus('AI正在生成建议...');
        }
      }
    });
    
    // 发送分析请求
    const assistPrompt = `请分析以下笔记内容，并提供有用的建议、补充信息或改进意见。可以包括：
1. 内容的总结和要点
2. 可能的改进建议
3. 相关的补充信息
4. 结构化建议

笔记内容：
${currentNote.content}`;
    
    window.sparkAPI.sendMessage(assistPrompt);
  } else {
    updateStatus('AI服务未初始化');
    aiAssistantBtn.disabled = false;
    setAIBusyState(false);
  }
}

async function convertToMarkdown() {
  // 检查登录状态，未登录时显示提示
  if (!requireLoginForAIFeature()) {
    return;
  }
  
  if (!currentId) {
    updateStatus('请先选择一个笔记');
    return;
  }
  
  const currentNote = notes.find(n => n.id === currentId);
  if (!currentNote || !currentNote.content.trim()) {
    updateStatus(getText('ai-empty-content'));
    return;
  }
  
  updateStatus('AI正在转换为Markdown格式...');
  markdownBtn.disabled = true;
  setAIBusyState(true);
  
  // 🔒 安全检查：先验证AI使用次数，再执行AI请求
  const hasQuota = await updateAIUsageData();
  if (!hasQuota) {
    markdownBtn.disabled = false;
    setAIBusyState(false);
    return;
  }
  
  // 设置AI响应回调
  if (window.sparkAPI) {
    let accumulatedResponse = ''; // 累积流式响应内容
    
    window.sparkAPI.setResponseCallback((response, type, isComplete) => {
      if (type === 'error') {
        updateStatus('Markdown转换失败: ' + response);
        markdownBtn.disabled = false;
        setAIBusyState(false);
        return;
      }
      
      if (type === 'assistant') {
        // 累积流式响应内容
        if (response) {
          accumulatedResponse += response;
        }
        
        // 实时更新笔记内容
        noteBody.value = accumulatedResponse;
        renderPreview();
        
        if (isComplete) {
          // 转换完成，保存笔记
          performSave();
          updateStatus('Markdown转换完成');
          markdownBtn.disabled = false;
          setAIBusyState(false);
          accumulatedResponse = ''; // 重置累积内容
        } else {
          updateStatus('AI正在生成Markdown格式...');
        }
      }
    });
    
    // 发送转换请求
    const markdownPrompt = `请将以下内容转换为标准的Markdown格式。保持原有的结构和信息，但使用Markdown语法来格式化标题、列表、强调文本等。保持原语言。如果内容已经是Markdown格式，请优化其格式和结构：

${currentNote.content}`;
    
    window.sparkAPI.sendMessage(markdownPrompt);
  } else {
    updateStatus('AI服务未初始化');
    markdownBtn.disabled = false;
    setAIBusyState(false);
  }
}

/* Preview rendering */
function renderPreview(){
  const md = noteBody.value || '';
  const html = marked.parse(md);
  // sanitize
  previewEl.innerHTML = DOMPurify.sanitize(html);
}

/* Export / Import */
function exportNotes(formatArg){
  // 支持通过按钮直接传参；若未传参则弹出选择
  let formatLower = (formatArg || '').toLowerCase();
  if (!formatLower) {
    const input = prompt(getText('export-format-prompt'), 'md');
    if (!input) return; // 用户取消
    formatLower = input.toLowerCase();
  }
  let data, mimeType, extension;
  
  switch(formatLower) {
    case 'txt':
      data = notes.map(note => {
        const createdDate = new Date(note.createdAt).toLocaleString();
        const updatedDate = new Date(note.updatedAt).toLocaleString();
        return `标题: ${note.title}\n创建时间: ${createdDate}\n更新时间: ${updatedDate}\n标签: ${note.tags ? note.tags.join(', ') : '无'}\n\n内容:\n${note.content}\n\n${'='.repeat(50)}\n`;
      }).join('\n');
      mimeType = 'text/plain';
      extension = 'txt';
      break;
      
    case 'md':
      data = notes.map(note => {
        const createdDate = new Date(note.createdAt).toLocaleString();
        const updatedDate = new Date(note.updatedAt).toLocaleString();
        const tags = note.tags && note.tags.length > 0 ? note.tags.map(tag => `#${tag}`).join(' ') : '';
        return `# ${note.title}\n\n**创建时间:** ${createdDate}  \n**更新时间:** ${updatedDate}  \n**标签:** ${tags}\n\n---\n\n${note.content}\n\n`;
      }).join('\n');
      mimeType = 'text/markdown';
      extension = 'md';
      break;
      
    default:
      alert(getText('unsupported-format'));
      return;
  }
  
  const blob = new Blob([data], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `notes_export.${extension}`;
  a.click();
  URL.revokeObjectURL(url);
  
  updateStatus(`${getText('export-success')} ${formatLower.toUpperCase()} 格式`);
}

function importFile(file){
  const reader = new FileReader();
  const fileName = file.name.toLowerCase();
  const fileExtension = fileName.split('.').pop();
  
  reader.onload = () => {
    try {
      let importedNotes = [];
      
      switch(fileExtension) {
        case 'txt':
          const txtContent = reader.result;
          // 按分隔符分割笔记
          const txtSections = txtContent.split('='.repeat(50));
          
          for (const section of txtSections) {
            const trimmedSection = section.trim();
            if (!trimmedSection) continue;
            
            const lines = trimmedSection.split('\n');
            let title = '', content = '', tags = [];
            let contentStartIndex = -1;
            
            // 解析标题、时间和标签
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              if (line.startsWith('标题: ')) {
                title = line.substring(3).trim();
              } else if (line.startsWith('标签: ')) {
                const tagStr = line.substring(3).trim();
                if (tagStr !== '无') {
                  tags = tagStr.split(',').map(tag => tag.trim()).filter(tag => tag);
                }
              } else if (line === '内容:') {
                contentStartIndex = i + 1;
                break;
              }
            }
            
            // 提取内容
            if (contentStartIndex >= 0) {
              content = lines.slice(contentStartIndex).join('\n').trim();
            }
            
            if (title && content) {
              importedNotes.push({
                id: uid(),
                title: title,
                content: content,
                tags: tags,
                createdAt: Date.now(),
                updatedAt: Date.now()
              });
            }
          }
          break;
          
        case 'md':
          const mdContent = reader.result;
          // 按标题分割笔记
          const mdSections = mdContent.split(/^# /m).filter(section => section.trim());
          
          for (const section of mdSections) {
            const lines = section.split('\n');
            const title = lines[0].trim();
            let content = '', tags = [];
            let contentStartIndex = -1;
            
            // 查找内容开始位置（在---分隔符之后）
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();
              if (line.startsWith('**标签:**')) {
                const tagStr = line.substring(6).trim();
                if (tagStr) {
                  tags = tagStr.split(' ').map(tag => tag.replace('#', '').trim()).filter(tag => tag);
                }
              } else if (line === '---') {
                contentStartIndex = i + 1;
                break;
              }
            }
            
            // 提取内容
            if (contentStartIndex >= 0) {
              content = lines.slice(contentStartIndex).join('\n').trim();
            }
            
            if (title && content) {
              importedNotes.push({
                id: uid(),
                title: title,
                content: content,
                tags: tags,
                createdAt: Date.now(),
                updatedAt: Date.now()
              });
            }
          }
          break;
          
        default:
          throw new Error('不支持的文件格式');
      }
      // Fallback：如果没有按结构解析出笔记，则作为单条笔记导入
      if (importedNotes.length === 0) {
        const baseTitle = file.name.replace(/\.[^.]+$/, '') || '未命名';
        importedNotes.push({
          id: uid(),
          title: baseTitle,
          content: reader.result,
          tags: [],
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
      }
      
      // 合并导入的笔记
      for (const item of importedNotes) {
        if (!item.id) item.id = uid();
        const idx = notes.findIndex(x=>x.id===item.id);
        if (idx>=0) notes[idx] = Object.assign({}, notes[idx], item);
        else notes.push(item);
      }
      
      saveNotesToStorage();
      renderNotesList(searchInput.value);
      updateStatus(`${getText('import-success')} ${importedNotes.length} 条笔记 (${fileExtension.toUpperCase()} 格式)`);
      
    } catch(e) {
      console.error(e);
      updateStatus(`${getText('import-failed')}：${e.message}`);
    }
  };
  reader.readAsText(file);
}

/* Delete */
async function deleteCurrentNote(){
  if (!currentId) return;
  const idx = notes.findIndex(x=>x.id===currentId);
  if (idx<0) return;
  
  // 使用自定义确认弹窗
  const confirmed = await customConfirm(getText('confirm-delete'));
  if (!confirmed) return;
  
  notes.splice(idx,1);
  currentId = notes.length ? notes[0].id : null;
  saveNotesToStorage();
  renderNotesList(searchInput.value);
  if (currentId) selectNote(currentId);
  else { noteTitle.value = ''; noteBody.value = ''; previewEl.innerHTML = ''; renderTags([]); updateStatus('status-deleted', true); }
}

/* Keyboard shortcuts */
document.addEventListener('keydown', (e) => {
  const mac = navigator.platform.toUpperCase().indexOf('MAC')>=0;
  const cmd = mac ? e.metaKey : e.ctrlKey;
  if (cmd && e.key.toLowerCase() === 'n') {
    e.preventDefault();
    newNote();
    return;
  }
  if (cmd && e.key.toLowerCase() === 's') {
    e.preventDefault();
    scheduleSaveImmediate();
    return;
  }
  if (cmd && e.key.toLowerCase() === 'f') {
    e.preventDefault();
    searchInput.focus();
    return;
  }
});

/* Event wiring */
newNoteBtn.addEventListener('click', newNote);
noteBody.addEventListener('input', () => { scheduleSave(); renderPreview(); });
noteTitle.addEventListener('input', scheduleSave);
togglePreviewBtn.addEventListener('click', () => {
  previewVisible = !previewVisible;
  previewEl.style.display = previewVisible ? 'block' : 'none';
});
toggleSidebarBtn.addEventListener('click', toggleSidebar);

// 自动补全开关按钮事件监听器
const autoCompleteToggleBtn = document.getElementById('autoCompleteToggleBtn');
autoCompleteToggleBtn.addEventListener('click', () => {
  // 检查按钮是否被禁用
  if (isAIButtonDisabled('autoCompleteToggleBtn')) {
    customAlert('AI次数已用完，请明天再试或升级会员');
    return;
  }
  
  if (!requireLoginForAIFeature(() => {
    autoCompleteEnabled = !autoCompleteEnabled;
    autoCompleteToggleBtn.setAttribute('data-enabled', autoCompleteEnabled.toString());
    
    // 如果关闭自动补全，隐藏当前显示的自动补全
    if (!autoCompleteEnabled) {
      hideAutoComplete();
    }
    
    updateStatus(autoCompleteEnabled ? getText('autocomplete-enabled') : getText('autocomplete-disabled'));
  })) {
    return;
  }
});

markdownBtn.addEventListener('click', () => {
  if (isAIButtonDisabled('markdownBtn')) {
    customAlert('AI次数已用完，请明天再试或升级会员');
    return;
  }
  convertToMarkdown();
});
aiOptimizeBtn.addEventListener('click', () => {
  // 检查按钮是否被禁用
  if (isAIButtonDisabled('aiOptimizeBtn')) {
    customAlert('AI次数已用完，请明天再试或升级会员');
    return;
  }
  
  if (!requireLoginForAIFeature(optimizeNoteWithAI)) {
    return;
  }
});

aiTranslateBtn.addEventListener('click', () => {
  // 检查按钮是否被禁用
  if (isAIButtonDisabled('aiTranslateBtn')) {
    customAlert('AI次数已用完，请明天再试或升级会员');
    return;
  }
  
  if (!requireLoginForAIFeature(translateNoteWithAI)) {
    return;
  }
});

aiAssistantBtn.addEventListener('click', () => {
  // 检查按钮是否被禁用
  if (isAIButtonDisabled('aiAssistantBtn')) {
    customAlert('AI次数已用完，请明天再试或升级会员');
    return;
  }
  
  if (!requireLoginForAIFeature(() => {
    aiInputContainer.style.display = 'block';
    aiCustomInput.focus();
  })) {
    return;
  }
});

aiSubmitBtn.addEventListener('click', () => {
  // 检查按钮是否被禁用
  if (isAIButtonDisabled('aiSubmitBtn')) {
    customAlert('AI次数已用完，请明天再试或升级会员');
    return;
  }
  
  if (!requireLoginForAIFeature(async () => {
    const customPrompt = aiCustomInput.value.trim();
    if (!customPrompt) {
      updateStatus(getText('ai-input-required'));
      return;
    }
    
    if (!currentId) {
      updateStatus('请先选择一个笔记');
      return;
    }
    
    const currentNote = notes.find(n => n.id === currentId);
    if (!currentNote) {
      updateStatus('未找到当前笔记');
      return;
    }
    
  updateStatus('AI正在处理您的请求...');
  aiSubmitBtn.disabled = true;
  aiInputContainer.style.display = 'none';
  setAIBusyState(true);
    
    // 🔒 安全检查：先验证AI使用次数，再执行AI请求
  const hasQuota = await updateAIUsageData();
  if (!hasQuota) {
      aiSubmitBtn.disabled = false;
      setAIBusyState(false);
      return;
  }
    
    if (window.sparkAPI) {
      let accumulatedResponse = ''; // 累积流式响应内容
      
      window.sparkAPI.setResponseCallback((response, type, isComplete) => {
        if (type === 'error') {
          updateStatus('AI处理失败: ' + response);
          aiSubmitBtn.disabled = false;
          setAIBusyState(false);
          return;
        }
        
        if (type === 'assistant') {
          // 累积流式响应内容
          if (response) {
            accumulatedResponse += response;
          }
          
          const separator = `\n\n---\n\n**${getText('ai-assistant-reply')}：**\n\n`;
          const originalContent = currentNote.content;
          
          const aiResponseIndex = originalContent.indexOf(`---\n\n**${getText('ai-assistant-reply')}：**`);
          let baseContent = aiResponseIndex !== -1 ? 
            originalContent.substring(0, aiResponseIndex).trim() : 
            originalContent;
          
          noteBody.value = baseContent + separator + accumulatedResponse;
          renderPreview();
          
          if (isComplete) {
            performSave();
            updateStatus('AI处理完成');
            aiSubmitBtn.disabled = false;
            aiCustomInput.value = '';
            setAIBusyState(false);
            accumulatedResponse = ''; // 重置累积内容
          } else {
            updateStatus('AI正在生成回复...');
          }
        }
      });
      
      const fullPrompt = `用户要求：${customPrompt}\n\n笔记内容：\n${currentNote.content}`;
      window.sparkAPI.sendMessage(fullPrompt);
    } else {
      updateStatus('AI服务未初始化');
      aiSubmitBtn.disabled = false;
      setAIBusyState(false);
    }
  })) {
    return;
  }
});

aiCancelBtn.addEventListener('click', () => {
   aiInputContainer.style.display = 'none';
   aiCustomInput.value = '';
 });

 // 添加键盘事件支持
  aiCustomInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      aiSubmitBtn.click();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      aiCancelBtn.click();
    }
  });

  // 自动补全功能
  async function triggerAutoComplete() {
    // 检查自动补全开关是否开启
    if (!autoCompleteEnabled) {
      hideAutoComplete();
      return;
    }
    
    // 检查AI次数是否足够
    if (!checkAIQuotaAvailable()) {
      hideAutoComplete();
      return;
    }
    
    if (!currentId || !window.sparkAPI) {
      return;
    }

    const currentNote = notes.find(n => n.id === currentId);
    if (!currentNote) {
      return;
    }

    const content = noteBody.value;
    if (!content.trim()) {
      hideAutoComplete();
      return;
    }

    // 获取光标位置前的文本
    const cursorPos = noteBody.selectionStart;
    const textBeforeCursor = content.substring(0, cursorPos);
    
    // 如果文本太短，不触发补全
    if (textBeforeCursor.length < 2) {
      hideAutoComplete();
      return;
    }

    // 🔒 安全检查：先验证AI使用次数，再执行AI请求
    const hasQuota = await updateAIUsageData();
    if (!hasQuota) {
      return;
    }

    isAutoCompleteActive = true;
    
    // 设置AI响应回调
    let accumulatedResponse = ''; // 累积流式响应内容
    
    window.sparkAPI.setResponseCallback((response, type, isComplete) => {
      if (!isAutoCompleteActive) return;
      
      if (type === 'error') {
        hideAutoComplete();
        return;
      }
      
      if (type === 'assistant') {
        // 累积流式响应内容
        if (response) {
          accumulatedResponse += response;
        }
        
        if (isComplete) {
          const suggestion = accumulatedResponse.trim();
          if (suggestion && suggestion.length > 0) {
            // 实现重复文本检测与清除机制
            const cleanedSuggestion = removeDuplicateText(textBeforeCursor, suggestion);
            
            // 调试信息：记录检测结果
            console.log('自动补全调试信息:');
            console.log('用户文本:', textBeforeCursor);
            console.log('AI响应:', suggestion);
            console.log('清理后:', cleanedSuggestion);
            
            if (cleanedSuggestion && cleanedSuggestion.length > 0) {
              showAutoComplete(cleanedSuggestion, cursorPos);
            } else {
              console.log('清理后内容为空，隐藏自动补全');
              hideAutoComplete();
            }
          } else {
            console.log('AI响应为空，隐藏自动补全');
            hideAutoComplete();
          }
          isAutoCompleteActive = false;
          accumulatedResponse = ''; // 重置累积内容
        }
      }
    });
    
    // 发送补全请求
    const prompt = `请智能补全以下文本。重要要求：
1. 只返回需要补全的新内容，不要重复用户已输入的文字
2. 补全内容要自然流畅，符合上下文语境
3. 如果是中文，补全中文；如果是英文，补全英文
4. 补全长度控制在10-30个字符内

用户已输入的文本：
${textBeforeCursor}

请补全：`;
    window.sparkAPI.sendMessage(prompt);
  }

  // 重复文本检测与清除函数
  function removeDuplicateText(userText, aiResponse) {
    if (!userText || !aiResponse) {
      return aiResponse;
    }
    
    // 清理用户文本和AI响应的首尾空白
    const cleanUserText = userText.trim();
    const cleanAiResponse = aiResponse.trim();
    
    // 如果AI响应为空，直接返回
    if (!cleanAiResponse) {
      return '';
    }
    
    // 调试信息
    console.log('重复检测 - 用户文本:', cleanUserText);
    console.log('重复检测 - AI响应:', cleanAiResponse);
    
    // 检查AI响应是否以用户文本开头（完全匹配）
    if (cleanAiResponse.startsWith(cleanUserText)) {
      // 移除重复部分，只保留补全的新内容
      const newContent = cleanAiResponse.substring(cleanUserText.length);
      console.log('完全匹配 - 移除重复:', newContent);
      return newContent.trim();
    }
    
    // 获取用户文本的最后几个词或字符，用于更精确的匹配
    const userWords = cleanUserText.split(/\s+/);
    const lastUserWord = userWords[userWords.length - 1] || '';
    
    // 检查AI响应是否以最后一个词开头（适用于中英文）
    if (lastUserWord && cleanAiResponse.startsWith(lastUserWord)) {
      const newContent = cleanAiResponse.substring(lastUserWord.length);
      console.log('最后词匹配 - 移除重复:', newContent);
      return newContent.trim();
    }
    
    // 检查部分重复的情况
    // 从用户文本的末尾开始，逐步减少长度，查找是否与AI响应的开头匹配
    for (let i = Math.min(cleanUserText.length, 50); i >= 3; i--) {
      const userSuffix = cleanUserText.substring(cleanUserText.length - i);
      if (cleanAiResponse.startsWith(userSuffix)) {
        // 找到重复部分，移除它
        const newContent = cleanAiResponse.substring(i);
        console.log('部分重复匹配 - 移除重复:', newContent);
        return newContent.trim();
      }
    }
    
    // 检查逐字符重复的情况
    let overlapLength = 0;
    const maxCheck = Math.min(cleanUserText.length, cleanAiResponse.length, 30);
    
    for (let i = 1; i <= maxCheck; i++) {
      const userEnd = cleanUserText.substring(cleanUserText.length - i);
      const aiStart = cleanAiResponse.substring(0, i);
      if (userEnd === aiStart) {
        overlapLength = i;
      }
    }
    
    if (overlapLength > 0) {
      const newContent = cleanAiResponse.substring(overlapLength);
      console.log('逐字符匹配 - 移除重复:', newContent);
      return newContent.trim();
    }
    
    // 没有发现重复，返回原始AI响应
    console.log('未发现重复 - 返回原始响应');
    return cleanAiResponse;
  }

  function showAutoComplete(suggestion, cursorPos) {
    currentSuggestion = suggestion;
    
    // 只显示补全建议，不显示原文本
    autoCompleteOverlay.innerHTML = `<span class="auto-complete-suggestion">${suggestion}</span>`;
    
    // 重新获取当前光标位置，确保位置计算准确
    const currentCursorPos = noteBody.selectionStart;
    const textBeforeCursor = noteBody.value.substring(0, currentCursorPos);
    
    // 创建一个临时的测量元素来精确计算文本宽度
    const measureElement = document.createElement('div');
    measureElement.style.position = 'absolute';
    measureElement.style.visibility = 'hidden';
    measureElement.style.whiteSpace = 'pre';
    measureElement.style.font = window.getComputedStyle(noteBody).font;
    measureElement.style.fontSize = window.getComputedStyle(noteBody).fontSize;
    measureElement.style.fontFamily = window.getComputedStyle(noteBody).fontFamily;
    measureElement.style.lineHeight = window.getComputedStyle(noteBody).lineHeight;
    document.body.appendChild(measureElement);
    
    // 分割文本为行
    const lines = textBeforeCursor.split('\n');
    const currentLineIndex = lines.length - 1;
    const currentLineText = lines[currentLineIndex];
    
    // 测量当前行的宽度
    measureElement.textContent = currentLineText;
    const textWidth = measureElement.offsetWidth;
    
    // 测量单行高度
    measureElement.textContent = 'M';
    const lineHeight = measureElement.offsetHeight;
    
    // 清理测量元素
    document.body.removeChild(measureElement);
    
    // 获取textarea的样式信息
    const computedStyle = window.getComputedStyle(noteBody);
    const paddingTop = parseInt(computedStyle.paddingTop) || 0;
    const paddingLeft = parseInt(computedStyle.paddingLeft) || 0;
    const borderTop = parseInt(computedStyle.borderTopWidth) || 0;
    const borderLeft = parseInt(computedStyle.borderLeftWidth) || 0;
    
    // 获取textarea的滚动位置
    const scrollTop = noteBody.scrollTop;
    const scrollLeft = noteBody.scrollLeft;
    
    // 计算精确位置，考虑滚动偏移
    const top = paddingTop + borderTop + (currentLineIndex * lineHeight) - scrollTop;
    const left = paddingLeft + borderLeft + textWidth - scrollLeft;
    
    // 确保自动补全层相对于textarea的父容器定位
    const textareaRect = noteBody.getBoundingClientRect();
    const editorRect = noteBody.parentElement.getBoundingClientRect();
    
    // 重新计算位置，确保相对于编辑器容器
    const relativeTop = top + textareaRect.top - editorRect.top;
    const relativeLeft = left + textareaRect.left - editorRect.left;
    
    autoCompleteOverlay.style.position = 'absolute';
    autoCompleteOverlay.style.top = `${relativeTop}px`;
    autoCompleteOverlay.style.left = `${relativeLeft}px`;
    autoCompleteOverlay.style.display = 'block';
    autoCompleteOverlay.style.pointerEvents = 'none';
  }

  function hideAutoComplete() {
    autoCompleteOverlay.style.display = 'none';
    autoCompleteOverlay.innerHTML = '';
    currentSuggestion = '';
    isAutoCompleteActive = false;
  }

  function acceptAutoComplete() {
    if (currentSuggestion) {
      const cursorPos = noteBody.selectionStart;
      const content = noteBody.value;
      const newContent = content.substring(0, cursorPos) + 
                        currentSuggestion + 
                        content.substring(cursorPos);
      
      noteBody.value = newContent;
      noteBody.selectionStart = noteBody.selectionEnd = cursorPos + currentSuggestion.length;
      
      hideAutoComplete();
      performSave();
      renderPreview();
    }
  }

  // 监听输入事件
  noteBody.addEventListener('input', () => {
    hideAutoComplete();
    
    // 检查登录状态，未登录时不触发自动补全
    if (!isUserLoggedIn()) {
      console.log('用户未登录，不触发自动补全');
      return;
    }
    
    // 检查自动补全功能是否开启
    if (!autoCompleteEnabled) {
      console.log('自动补全功能未开启');
      return;
    }
    
    // 清除之前的定时器
    if (autoCompleteTimeout) {
      clearTimeout(autoCompleteTimeout);
    }
    
    // 设置1秒延迟触发
    autoCompleteTimeout = setTimeout(() => {
      console.log('触发自动补全');
      triggerAutoComplete();
    }, 1000);
  });

  // 监听键盘事件
  noteBody.addEventListener('keydown', (e) => {
    if (e.key === 'Tab' && currentSuggestion) {
      e.preventDefault();
      acceptAutoComplete();
    } else if (e.key === 'Escape' && currentSuggestion) {
      e.preventDefault();
      hideAutoComplete();
    }
  });

  // 监听光标位置变化
  noteBody.addEventListener('selectionchange', () => {
    if (currentSuggestion) {
      hideAutoComplete();
    }
  });

  // 监听滚动事件
  noteBody.addEventListener('scroll', () => {
    if (currentSuggestion) {
      hideAutoComplete();
    }
  });

  // 切换无边际模式
  function toggleBorderlessMode(enabled) {
    const main = document.querySelector('.main');
    const editorUnified = document.querySelector('.editor-unified');
    const preview = document.querySelector('.preview');
    
    if (enabled) {
      // 启用无边际模式
      main.style.padding = '0';
      main.style.background = 'white';
      const editorWrap = document.querySelector('.editor-wrap');
      editorWrap.style.gap = '0';
      editorUnified.style.border = 'none';
      editorUnified.style.borderRight = '1px solid #e5e5e7'; // 保持右侧分隔线
      editorUnified.style.borderRadius = '0';
      editorUnified.style.background = 'transparent';
      editorUnified.style.boxShadow = 'none';
      editorUnified.style.padding = '20px';
      preview.style.border = 'none';
      preview.style.borderRadius = '0';
      preview.style.background = 'transparent';
      preview.style.boxShadow = 'none';
      preview.style.padding = '20px';
      
      // 恢复底部信息栏原始样式
      const footer = document.querySelector('.footer');
      footer.style.border = 'none';
      footer.style.borderRadius = '0';
      footer.style.background = 'transparent';
      footer.style.boxShadow = 'none';
      footer.style.marginTop = '10px';
    } else {
      // 禁用无边际模式，优化有边模式样式
      main.style.padding = '16px';
       main.style.background = 'white';
       const editorWrap = document.querySelector('.editor-wrap');
       editorWrap.style.gap = '12px';
      editorUnified.style.border = '1px solid #f0f0f0';
       editorUnified.style.borderRight = '1px solid #f0f0f0';
       editorUnified.style.borderRadius = '16px';
      editorUnified.style.background = 'white';
       editorUnified.style.boxShadow = '0 2px 4px -1px rgba(0, 0, 0, 0.04), 0 1px 2px -1px rgba(0, 0, 0, 0.02)';
       editorUnified.style.padding = '28px';
       preview.style.border = '1px solid #f0f0f0';
       preview.style.borderRadius = '16px';
       preview.style.background = 'white';
       preview.style.boxShadow = '0 2px 4px -1px rgba(0, 0, 0, 0.04), 0 1px 2px -1px rgba(0, 0, 0, 0.02)';
       preview.style.padding = '28px';
       
       // 底部信息栏样式
       const footer = document.querySelector('.footer');
       footer.style.border = '1px solid #f0f0f0';
       footer.style.borderRadius = '16px';
       footer.style.background = 'white';
       footer.style.boxShadow = '0 2px 4px -1px rgba(0, 0, 0, 0.04), 0 1px 2px -1px rgba(0, 0, 0, 0.02)';
       footer.style.marginTop = '12px';
    }
  }

  // 切换分割线显示
  function toggleDividerLines(enabled) {
    const editorTopUnified = document.querySelector('.editor-top-unified');
    const footer = document.querySelector('.footer');
    
    if (enabled) {
      // 显示分割线
      editorTopUnified.style.borderBottom = '1px solid #e5e5e7';
      editorTopUnified.style.paddingBottom = '12px';
      footer.style.borderTop = '1px solid #e5e5e7';
    } else {
      // 隐藏分割线
      editorTopUnified.style.borderBottom = 'none';
      editorTopUnified.style.paddingBottom = '0';
      footer.style.borderTop = 'none';
    }
  }

  // 切换液态玻璃模式
  function toggleLiquidGlassMode(enabled) {
    const body = document.body;
    
    if (enabled) {
      // 启用液态玻璃模式
      body.classList.add('liquid-glass-mode');
      localStorage.setItem('liquidGlassMode', 'true');
    } else {
      // 禁用液态玻璃模式
      body.classList.remove('liquid-glass-mode');
      localStorage.setItem('liquidGlassMode', 'false');
    }
  }

  // 切换字体加粗模式
  function toggleBoldFontMode(enabled) {
    const body = document.body;
    
    if (enabled) {
      // 启用字体加粗模式
      body.classList.add('bold-font-mode');
      localStorage.setItem('boldFontMode', 'true');
    } else {
      // 禁用字体加粗模式
      body.classList.remove('bold-font-mode');
      localStorage.setItem('boldFontMode', 'false');
    }
  }

  // 切换字体加大模式
  function toggleFontSizeMode(enabled) {
    const body = document.body;
    
    if (enabled) {
      // 启用字体加大模式
      body.classList.add('font-size-mode');
      localStorage.setItem('fontSizeMode', 'true');
    } else {
      // 禁用字体加大模式
      body.classList.remove('font-size-mode');
      localStorage.setItem('fontSizeMode', 'false');
    }
  }

  // 获取国际化文本
  function getText(key) {
    return i18nTexts[currentLanguage][key] || key;
  }

  // 更新界面文本
  function updateUITexts() {
    // 更新所有带有data-i18n属性的元素
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach(element => {
      const key = element.getAttribute('data-i18n');
      const text = getText(key);
      
      if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'search')) {
        element.placeholder = text;
      } else if (element.tagName === 'TEXTAREA') {
        element.placeholder = text;
      } else if (element.tagName === 'BUTTON') {
        // 对于按钮，更新title属性和文本内容
        element.title = text;
        if (element.textContent.trim() && !element.querySelector('svg')) {
          element.textContent = text;
        }
      } else {
        element.textContent = text;
      }
    });

    // 更新欢迎笔记的内容（如果存在）
    const welcomeNote = notes.find(note => 
      note.title === '欢迎使用 Notes（示例）' || 
      note.title === 'Welcome to Notes (Demo)' ||
      note.title === getText('welcome-title')
    );
    if (welcomeNote && currentId === welcomeNote.id) {
      // 始终使用中文标题和内容，无论当前语言设置
      welcomeNote.title = '欢迎使用 Notes（示例）';
      welcomeNote.content = '这是一个简约的笔记应用，支持 AI 功能。支持 **Markdown** 语法。试试看：\n\n- ⌘/Ctrl+N 新建笔记\n- 自动保存笔记内容\n- （从左到右）第一个按钮：折叠/展开左侧笔记列表\n- 第二个：将笔记转换为 Markdown 格式\n- 第三个：AI 优化笔记格式/表达\n- 第四个：向 AI 提出个性化请求\n- 第五个：AI 自动补全功能，试试看\n\n```\nconsole.log(\"hello\")\n```\n产品正在开发中，不代表最终质量。\n反馈/建议：smtoffice@yeah.net';
      renderNotesList();
      renderCurrentNote();
    }
  }

  // 切换语言
  function toggleLanguage(enabled) {
    currentLanguage = enabled ? 'en' : 'zh';
    localStorage.setItem('language', currentLanguage);
    updateUITexts();
  }

  exportBtn.addEventListener('click', () => exportDialog.showModal());
  exportTxtOption.addEventListener('click', () => { exportNotes('txt'); exportDialog.close(); });
  exportMdOption.addEventListener('click', () => { exportNotes('md'); exportDialog.close(); });
  exportCancelBtn.addEventListener('click', () => exportDialog.close());
  importBtn.addEventListener('click', () => hiddenFileInput.click());
// 初始化设置
  function initializeSettings() {
    // 初始化语言设置
    const savedLanguage = localStorage.getItem('language') || 'zh';
    currentLanguage = savedLanguage;
    const englishModeEnabled = savedLanguage === 'en';
    document.getElementById('englishToggle').checked = englishModeEnabled;
    updateUITexts(); // 应用语言设置

    // 初始化无边际模式
    const borderlessModeEnabled = localStorage.getItem('borderlessMode') !== 'false'; // 默认开启
    toggleBorderlessMode(borderlessModeEnabled);
    document.getElementById('borderlessToggle').checked = borderlessModeEnabled;

    // 初始化分割线
    const dividerLinesEnabled = localStorage.getItem('dividerLines') !== 'false'; // 默认开启
    toggleDividerLines(dividerLinesEnabled);
    document.getElementById('dividerToggle').checked = dividerLinesEnabled;

    // 初始化液态玻璃模式
  const liquidGlassModeEnabled = localStorage.getItem('liquidGlassMode') === 'true'; // 默认关闭
  toggleLiquidGlassMode(liquidGlassModeEnabled);
  document.getElementById('liquidGlassToggle').checked = liquidGlassModeEnabled;

  // 初始化字体加粗模式
  const boldFontModeEnabled = localStorage.getItem('boldFontMode') === 'true'; // 默认关闭
  toggleBoldFontMode(boldFontModeEnabled);
  document.getElementById('boldFontToggle').checked = boldFontModeEnabled;

  // 初始化字体加大模式
  const fontSizeModeEnabled = localStorage.getItem('fontSizeMode') === 'true'; // 默认关闭
  toggleFontSizeMode(fontSizeModeEnabled);
  document.getElementById('fontSizeToggle').checked = fontSizeModeEnabled;
  }

  // 事件监听器
  deleteBtn.addEventListener('click', deleteCurrentNote);
hiddenFileInput.addEventListener('change', (e) => {
  if (e.target.files && e.target.files[0]) importFile(e.target.files[0]);
  hiddenFileInput.value = '';
});
// 设置页面事件监听器
settingsBtn.addEventListener('click', () => {
  settingsPage.style.display = 'block';
});

closeSettingsBtn.addEventListener('click', () => {
  settingsPage.style.display = 'none';
});

// 初始化个人资料按钮和登录界面事件监听器
function setupProfileEvents() {
  const profileBtn = document.getElementById('profileBtn');
  const profilePage = document.getElementById('profilePage');
  const loginPage = document.getElementById('loginPage');
  const closeProfileBtn = document.getElementById('closeProfileBtn');
  const closeLoginBtn = document.getElementById('closeLoginBtn');

  // 个人资料按钮点击事件
  profileBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    
    if (currentUser) {
      // 用户已登录，显示个人资料页面
      showProfilePage();
    } else {
      // 用户未登录，显示登录页面
      loginPage.style.display = 'block';
      // 初始化用户状态
      initializeUser();
    }
  });

  // 显示个人资料页面
  async function showProfilePage() {
    // 更新个人资料页面中的用户信息
    document.getElementById('profileUsername').textContent = currentUser.username;
    document.getElementById('profileEmail').textContent = currentUser.email;
    document.getElementById('profileCreatedAt').textContent = '注册于 ' + formatDate(currentUser.createdAt);
    // 更新会员徽章
    const badgeEl = document.getElementById('profileUserType');
    if (badgeEl) {
      const m = currentUser.membership;
      const valid = m && m.tier && (!m.expiresAt || new Date(m.expiresAt) > new Date());
      badgeEl.textContent = valid ? m.tier : 'free';
      // 切换徽章颜色类
      badgeEl.classList.remove('badge-plus', 'badge-pro');
      if (valid && m.tier) {
        const tier = String(m.tier).toLowerCase();
        if (tier === 'plus') {
          badgeEl.classList.add('badge-plus');
        } else if (tier === 'pro') {
          badgeEl.classList.add('badge-pro');
        }
      }
      // 在徽章旁显示到期提示（仅当有到期时间时）
      const expiryEl = document.getElementById('profileMembershipExpiry');
      if (expiryEl) {
        if (m && m.tier && m.expiresAt) {
          const now = new Date();
          const exp = new Date(m.expiresAt);
          const diffMs = exp - now;
          if (diffMs > 0) {
            const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
            expiryEl.textContent = `会员将在 ${daysLeft} 天后过期`;
            expiryEl.style.display = '';
          } else {
            expiryEl.textContent = '会员已过期';
            expiryEl.style.display = '';
          }
        } else {
          expiryEl.textContent = '';
          expiryEl.style.display = 'none';
        }
      }
    }
    
    // 更新头像显示为 n-logo.png
    const avatar = document.getElementById('profileAvatar');
    avatar.innerHTML = '<img src="n-logo.png" alt="Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">';
    
    // 更新统计数据，添加动画效果
    const noteCount = notes.length;
    
    // 平滑动画更新数字
    animateNumber('profileNoteCount', noteCount);
    // 刷新AI剩余次数显示（会员显示♾️，免费显示剩余次数）
    updateAIUsageDisplay();
    
    // 获取并显示云盘使用情况
    await updateStorageUsage();
    
    // 显示个人资料页面，添加淡入效果
    profilePage.style.display = 'block';
    profilePage.style.opacity = '0';
    
    // 强制重排以应用初始状态
    profilePage.offsetHeight;
    
    // 开始淡入动画
    requestAnimationFrame(() => {
      profilePage.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
      profilePage.style.opacity = '1';
    });
  }

  // 数字动画函数
  function animateNumber(elementId, targetValue) {
    const element = document.getElementById(elementId);
    const startValue = 0;
    const duration = 800; // 动画持续时间
    const startTime = performance.now();
    
    // 添加缩放动画
    element.style.transform = 'scale(1.1)';
    element.style.transition = 'transform 0.2s cubic-bezier(0.4, 0, 0.2, 1)';
    
    function updateNumber(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      // 使用缓动函数
      const easeOutQuart = 1 - Math.pow(1 - progress, 4);
      const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOutQuart);
      
      element.textContent = currentValue;
      
      if (progress < 1) {
        requestAnimationFrame(updateNumber);
      } else {
        // 动画结束后恢复原始大小
        setTimeout(() => {
          element.style.transform = 'scale(1)';
        }, 200);
      }
    }
    
    requestAnimationFrame(updateNumber);
  }

  // 获取并更新云盘使用情况
  async function updateStorageUsage() {
    try {
      const result = await apiRequest('/users/storage');
      
      if (result.success) {
        const storage = result.storage;
        // 仅更新存储卡片相关信息，不影响AI统计
        
        // 更新存储概览中的百分比
        const storagePercentageElement = document.querySelector('.storage-percentage');
        if (storagePercentageElement) {
          storagePercentageElement.textContent = `${storage.usedPercentage}%`;
        }
        
        // 更新存储进度条
        const storageFillElement = document.querySelector('.storage-fill');
        if (storageFillElement) {
          storageFillElement.style.width = `${storage.usedPercentage}%`;
        }
        
        // 更新存储详情
        const storageDetailsElement = document.querySelector('.storage-details');
        if (storageDetailsElement) {
          storageDetailsElement.textContent = `${storage.formattedUsedSpace} / ${storage.formattedTotalSpace}`;
        }
        
        // 兼容旧版本元素（如果存在）
        const legacyElements = {
          'storageUsed': storage.formattedUsedSpace,
          'storageTotal': storage.formattedTotalSpace,
          'storagePercentage': `(${storage.usedPercentage}%)`,
          'storageAvailable': `${storage.formattedAvailableSpace} 可用`,
          'profileStorageUsed': storage.formattedUsedSpace
        };
        
        Object.entries(legacyElements).forEach(([id, value]) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
          }
        });
        
        // 更新旧版本进度条（如果存在）
        const progressFill = document.getElementById('storageProgressFill');
        if (progressFill) {
          progressFill.style.width = `${storage.usedPercentage}%`;
          progressFill.className = 'storage-progress-fill';
          if (storage.usedPercentage >= 90) {
            progressFill.classList.add('high');
          } else if (storage.usedPercentage >= 70) {
            progressFill.classList.add('medium');
          } else {
            progressFill.classList.add('low');
          }
          progressFill.style.transition = 'width 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
        }
        
        console.log('云盘使用情况更新成功:', storage);
      }
    } catch (error) {
      console.error('获取云盘使用情况失败:', error);
      
      // 显示错误状态
      const errorElements = [
        { selector: '.stat-item:nth-child(2) .stat-number', value: '错误' },
        { selector: '.stat-item:nth-child(3) .stat-number', value: '错误' },
        { selector: '.storage-percentage', value: '0%' },
        { selector: '.storage-details', value: '无法获取数据' }
      ];
      
      errorElements.forEach(({ selector, value }) => {
        const element = document.querySelector(selector);
        if (element) {
          element.textContent = value;
        }
      });
      
      // 重置进度条
      const storageFillElement = document.querySelector('.storage-fill');
      if (storageFillElement) {
        storageFillElement.style.width = '0%';
      }
      
      // 兼容旧版本错误处理
      const legacyErrorElements = {
        'storageUsed': '获取失败',
        'storagePercentage': '(错误)',
        'storageAvailable': '无法获取数据'
      };
      
      Object.entries(legacyErrorElements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        }
      });
      
      const progressFill = document.getElementById('storageProgressFill');
      if (progressFill) {
        progressFill.style.width = '0%';
        progressFill.className = 'storage-progress-fill';
      }
    }
  }

  // 关闭个人资料页面
  closeProfileBtn.addEventListener('click', () => {
    // 添加淡出效果
    profilePage.style.transition = 'opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1)';
    profilePage.style.opacity = '0';
    
    setTimeout(() => {
      profilePage.style.display = 'none';
      profilePage.style.transition = '';
    }, 200);
  });

  // 关闭登录页面
  closeLoginBtn.addEventListener('click', () => {
    loginPage.style.display = 'none';
  });

  // 个人资料页面退出登录按钮点击事件（使用事件委托）
  profilePage.addEventListener('click', (e) => {
    if (e.target.closest('.profile-action-btn.secondary')) {
      logoutUser();
      profilePage.style.display = 'none';
    }
  });

  // 个人资料页面修改密码按钮点击事件（使用事件委托）
  profilePage.addEventListener('click', (e) => {
    if (e.target.closest('.profile-action-btn.primary')) {
      alert('修改密码功能待开发');
    }
  });

  // 忘记密码链接事件
  document.querySelector('.forgot-password').addEventListener('click', (e) => {
    e.preventDefault();
    alert('忘记密码功能待开发');
  });

  // 充值按钮点击事件
  const rechargeBtn = document.getElementById('rechargeBtn');
  if (rechargeBtn) {
    rechargeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (currentUser) {
        openUpgradePage();
      } else {
        loginPage.style.display = 'block';
        initializeUser();
      }
    });
  }
}

// 无边际模式切换
borderlessToggle.addEventListener('change', (e) => {
  toggleBorderlessMode(e.target.checked);
});

// 分割线切换
dividerToggle.addEventListener('change', (e) => {
  toggleDividerLines(e.target.checked);
});

// 液态玻璃模式切换
const liquidGlassToggle = document.getElementById('liquidGlassToggle');
liquidGlassToggle.addEventListener('change', (e) => {
  toggleLiquidGlassMode(e.target.checked);
});

// 英文版切换
const englishToggle = document.getElementById('englishToggle');
englishToggle.addEventListener('change', (e) => {
  toggleLanguage(e.target.checked);
});

// 字体加粗切换
const boldFontToggle = document.getElementById('boldFontToggle');
boldFontToggle.addEventListener('change', (e) => {
  toggleBoldFontMode(e.target.checked);
});

// 字体加大切换
const fontSizeToggle = document.getElementById('fontSizeToggle');
fontSizeToggle.addEventListener('change', (e) => {
  toggleFontSizeMode(e.target.checked);
});

searchInput.addEventListener('input', () => renderNotesList(searchInput.value));

/* Bootstrap */
(function init(){
  initializeSettings(); // 在init函数中调用初始化设置
  setupAuthForms(); // 初始化登录/注册表单
  setupProfileEvents(); // 初始化个人资料按钮事件
  initializeUser(); // 初始化用户状态
  loadNotesFromStorage();
  if (!notes.length) {
    // seed one note - 始终使用中文欢迎笔记
    notes.push({
      id: uid(),
      title: '欢迎使用 Notes（示例）',
      content: '这是一个简约的笔记应用，支持 AI 功能。支持 **Markdown** 语法。试试看：\n\n- ⌘/Ctrl+N 新建笔记\n- 自动保存笔记内容\n- （从左到右）第一个按钮：折叠/展开左侧笔记列表\n- 第二个：将笔记转换为 Markdown 格式\n- 第三个：AI 优化笔记格式/表达\n- 第四个：向 AI 提出个性化请求\n- 第五个：AI 自动补全功能，试试看\n\n```\nconsole.log(\"hello\")\n```\n产品正在开发中，不代表最终质量。\n反馈/建议：smtoffice@yeah.net',
      tags: ['示例'],
      createdAt: nowISO(),
      updatedAt: nowISO()
    });
    saveNotesToStorage();
  }
  // select first note (most recent)
  notes.sort((a,b)=> new Date(b.updatedAt||b.createdAt) - new Date(a.updatedAt||a.createdAt));
  currentId = notes[0].id;
  renderNotesList();
  selectNote(currentId);
  previewVisible = false;
  previewEl.style.display = 'none';
})();

// 自定义弹窗系统
class CustomModal {
  constructor() {
    this.modalId = 'custom-modal-' + Date.now();
    this.createModal();
  }

  createModal() {
    const modalHTML = `
      <div id="${this.modalId}" class="modal-overlay">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">提示</h3>
            <button class="modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="modal-message"></div>
            <input type="text" class="modal-input" style="display: none;">
          </div>
          <div class="modal-footer">
            <button class="modal-btn secondary" style="display: none;">取消</button>
            <button class="modal-btn primary">确定</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    this.modal = document.getElementById(this.modalId);
    this.setupEventListeners();
  }

  setupEventListeners() {
    const closeBtn = this.modal.querySelector('.modal-close');
    const overlay = this.modal;
    const cancelBtn = this.modal.querySelector('.modal-btn.secondary');
    const confirmBtn = this.modal.querySelector('.modal-btn.primary');

    closeBtn.addEventListener('click', () => this.close());
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) this.close();
    });

    cancelBtn.addEventListener('click', () => {
      if (this.onCancel) this.onCancel();
      this.close();
    });

    confirmBtn.addEventListener('click', () => {
      if (this.onConfirm) this.onConfirm();
      this.close();
    });
  }

  alert(message, title = '提示', type = 'info') {
    return new Promise((resolve) => {
      this.showModal(message, title, type, 'alert');
      this.onConfirm = () => resolve(true);
    });
  }

  confirm(message, title = '确认', type = 'warning') {
    return new Promise((resolve) => {
      this.showModal(message, title, type, 'confirm');
      this.onConfirm = () => resolve(true);
      this.onCancel = () => resolve(false);
    });
  }

  prompt(message, defaultValue = '', title = '输入', type = 'info') {
    return new Promise((resolve) => {
      this.showModal(message, title, type, 'prompt', defaultValue);
      this.onConfirm = () => {
        const input = this.modal.querySelector('.modal-input');
        resolve(input.value);
      };
      this.onCancel = () => resolve(null);
    });
  }

  showModal(message, title, type, mode, defaultValue = '') {
    const titleEl = this.modal.querySelector('.modal-title');
    const messageEl = this.modal.querySelector('.modal-message');
    const inputEl = this.modal.querySelector('.modal-input');
    const cancelBtn = this.modal.querySelector('.modal-btn.secondary');
    const confirmBtn = this.modal.querySelector('.modal-btn.primary');

    // 设置标题和内容
    titleEl.textContent = title;
    messageEl.textContent = message;

    // 设置图标
    const iconHTML = this.getIconHTML(type);
    messageEl.innerHTML = iconHTML + message;

    // 根据模式显示不同的按钮
    if (mode === 'alert') {
      cancelBtn.style.display = 'none';
      confirmBtn.textContent = '确定';
    } else if (mode === 'confirm') {
      cancelBtn.style.display = 'inline-block';
      confirmBtn.textContent = '确定';
    } else if (mode === 'prompt') {
      cancelBtn.style.display = 'inline-block';
      confirmBtn.textContent = '确定';
      inputEl.style.display = 'block';
      inputEl.value = defaultValue;
      inputEl.focus();
    }

    // 显示弹窗
    setTimeout(() => {
      this.modal.classList.add('active');
    }, 10);
  }

  getIconHTML(type) {
    // 使用 attention.svg 作为所有类型的图标
    return `<div class="modal-icon ${type}"><img src="attention.svg" alt="${type}" class="modal-icon-svg"></div>`;
  }

  close() {
    this.modal.classList.remove('active');
    setTimeout(() => {
      if (this.modal && this.modal.parentNode) {
        this.modal.parentNode.removeChild(this.modal);
      }
    }, 300);
  }
}

// 替换原生弹窗函数
window.customAlert = function(message, title = '提示') {
  const modal = new CustomModal();
  return modal.alert(message, title);
};

window.customConfirm = function(message, title = '确认') {
  const modal = new CustomModal();
  return modal.confirm(message, title);
};

window.customPrompt = function(message, defaultValue = '', title = '输入') {
  const modal = new CustomModal();
  return modal.prompt(message, defaultValue, title);
};

// 重写原生弹窗
window.alert = function(message) {
  return customAlert(message);
};

window.confirm = function(message) {
  return customConfirm(message);
};

window.prompt = function(message, defaultValue = '') {
  return customPrompt(message, defaultValue);
};

// 升级计划相关函数
function openUpgradePage() {
  // 移除已有的覆盖层以避免重复
  const existingOverlay = document.querySelector('.modal-overlay');
  if (existingOverlay) existingOverlay.remove();

  // 创建升级页面的模态框
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `
    <div class="modal-container upgrade-modal">
      <div class="modal-header">
        <h2>选择升级计划</h2>
        <div class="billing-toggle" aria-label="billing cycle">
          <button class="toggle-btn active" data-cycle="monthly">月度</button>
          <button class="toggle-btn" data-cycle="yearly">年度</button>
        </div>
        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="upgrade-plans upgrade-plans-3">
          <div class="plan-card free">
            <div class="plan-header">
              <h3>Free 套餐</h3>
              <div class="plan-price"><span class="price">¥0</span></div>
            </div>
            <ul class="plan-features">
              <li>2MB的云空间</li>
              <li>极少的AI使用次数</li>
            </ul>
            <button class="plan-btn disabled" disabled>当前套餐</button>
          </div>

          <div class="plan-card plus featured">
            <div class="plan-badge">推荐</div>
            <div class="plan-header">
              <h3>Plus 套餐</h3>
              <div class="plan-price"><span class="price">¥3.9</span><span class="period">/月</span></div>
            </div>
            <ul class="plan-features">
              <li>更大的云空间（200MB）</li>
              <li>每月150次AI使用次数</li>
              <li>专属的私人客服</li>
            </ul>
            <button class="plan-btn primary" onclick="handlePlanUpgrade('plus')">立即升级 Plus</button>
          </div>

          <div class="plan-card pro">
            <div class="plan-header">
              <h3>Pro 套餐</h3>
              <div class="plan-price"><span class="price">¥5.9</span><span class="period">/月</span></div>
            </div>
            <ul class="plan-features">
              <li>巨大的云空间（500MB）</li>
              <li>更高级的AI模型-GPT级别</li>
              <li>无限制的AI请求</li>
              <li>专属的私人客服</li>
              <li>个性化定制</li>
            </ul>
            <button class="plan-btn" onclick="handlePlanUpgrade('pro')">立即升级 Pro</button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  // 添加升级模态框的样式
  if (!document.querySelector('#upgrade-modal-styles')) {
    const style = document.createElement('style');
    style.id = 'upgrade-modal-styles';
    style.textContent = `
      .upgrade-modal { max-width: 1200px; width: 95%; }
      .modal-header { display:flex; align-items:center; justify-content: space-between; gap:12px; }
      .billing-toggle { display:flex; gap:6px; padding:6px; margin-left:auto; background: rgba(255,255,255,0.65); backdrop-filter: saturate(140%) blur(6px); border:1px solid rgba(0,0,0,0.06); border-radius:12px; box-shadow: 0 2px 8px rgba(77,166,255,0.08); }
      .billing-toggle .toggle-btn { min-width:64px; padding:8px 12px; border:none; background: transparent; border-radius:10px; font-size:14px; font-weight:500; color:#555; cursor:pointer; transition: all .2s ease; }
      .billing-toggle .toggle-btn:hover { color:#4da6ff; }
      .billing-toggle .toggle-btn.active { background: rgba(77,166,255,0.12); color:#0A84FF; box-shadow: inset 0 0 0 1px rgba(77,166,255,0.25); }
      @media (max-width: 640px) { .modal-header { flex-wrap: wrap; } .billing-toggle { width:100%; justify-content:center; } }
      .upgrade-plans-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
      .plan-card { background: rgba(255,255,255,0.95); border: 1px solid rgba(0,0,0,0.08); border-radius: 16px; padding: 32px; position: relative; transition: transform .2s ease, box-shadow .2s ease; display: flex; flex-direction: column; }
      .plan-card.featured { border-color: #4da6ff; box-shadow: 0 8px 24px rgba(77,166,255,.15); }
      .plan-badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg,#4da6ff,#3399ff); color:#fff; padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; }
      .plan-header h3 { margin: 0 0 8px; font-size: 18px; color: #1d1d1f; }
      .plan-price .price { font-size: 28px; font-weight: 700; color: #4da6ff; }
      .plan-price .period { font-size: 14px; color: #86868b; margin-left: 4px; }
      .plan-features { list-style: none; padding: 0; margin: 16px 0; flex-grow: 1; }
      .plan-features li { padding: 6px 0 6px 22px; font-size: 14px; color: #5a5a5f; position: relative; }
      .plan-features li::before { content: '✓'; position: absolute; left: 0; color: #4da6ff; font-weight: 700; }
      .plan-btn { width: 100%; padding: 12px 18px; border: 1px solid #4da6ff; border-radius: 12px; background: transparent; color: #4da6ff; font-size: 14px; font-weight: 600; cursor: pointer; transition: all .2s ease; margin-top: auto; }
      .plan-btn.primary { background: linear-gradient(135deg,#4da6ff,#3399ff); color: #fff; border: none; }
      .plan-btn.disabled { opacity: .6; cursor: not-allowed; }
      .plan-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,.12); }
      @media (max-width: 860px) { .upgrade-plans-3 { grid-template-columns: 1fr; } }
    `;
    document.head.appendChild(style);
  }

  // 计费周期切换与价格更新
  window.billingCycle = 'monthly';
  function updateUpgradePrices(cycle) {
    const plusPriceEl = modal.querySelector('.plan-card.plus .plan-price');
    const proPriceEl = modal.querySelector('.plan-card.pro .plan-price');
    if (!plusPriceEl || !proPriceEl) return;
    if (cycle === 'yearly') {
      plusPriceEl.innerHTML = '<span class="price">¥39</span><span class="period">/年</span>';
      proPriceEl.innerHTML = '<span class="price">¥59</span><span class="period">/年</span>';
    } else {
      plusPriceEl.innerHTML = '<span class="price">¥3.9</span><span class="period">/月</span>';
      proPriceEl.innerHTML = '<span class="price">¥5.9</span><span class="period">/月</span>';
    }
  }
  const toggle = modal.querySelector('.billing-toggle');
  if (toggle) {
    const buttons = toggle.querySelectorAll('.toggle-btn');
    buttons.forEach(btn => btn.addEventListener('click', () => {
      buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      window.billingCycle = btn.dataset.cycle;
      updateUpgradePrices(window.billingCycle);
    }));
  }
  updateUpgradePrices(window.billingCycle);
}

function handlePlanUpgrade(plan) {
  const planName = plan === 'plus' ? 'Plus' : 'Pro';
  const cycle = window.billingCycle === 'yearly' ? 'yearly' : 'monthly';
  const planPrice = cycle === 'yearly' ? (plan === 'plus' ? '39' : '59') : (plan === 'plus' ? '3.9' : '5.9');
  const cycleLabel = cycle === 'yearly' ? '年' : '月';
  
  // 移除已存在的付款模态框
  const existingPaymentModal = document.querySelector('.payment-modal-overlay');
  if (existingPaymentModal) {
    existingPaymentModal.remove();
  }

  const paymentModal = document.createElement('div');
  paymentModal.className = 'payment-modal-overlay active';
  paymentModal.innerHTML = `
    <div class="payment-modal-container">
      <div class="payment-modal-header">
        <div class="payment-title-group">
          <h3>升级到 ${planName} 套餐</h3>
          <div class="payment-subtitle">解锁高级功能，享受更佳体验</div>
        </div>
        <div class="price-chip" aria-label="price">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1v22"></path>
            <path d="M17 5H9.5a3.5 3.5 0 100 7H14a3.5 3.5 0 010 7H6"></path>
          </svg>
          <span>¥${planPrice}/${cycleLabel}</span>
        </div>
        <button class="payment-modal-close" onclick="this.closest('.payment-modal-overlay').remove()" title="关闭">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="payment-modal-body">
        <div class="payment-content">
          <div class="payment-left">
            <div class="qr-panel">
              <div class="qr-code-container">
                <img src="ewm.PNG" alt="微信支付二维码" class="qr-code">
                <p class="qr-code-label"><img src="wx.PNG" alt="微信图标" class="qr-logo"> 微信扫码支付</p>
              </div>
            </div>
          </div>
          <div class="payment-right">
            <div class="payment-info">
              <h3 class="payment-info-title">使用微信扫一扫完成支付</h3>
              <p class="plan-selection">当前选择：<strong>${planName}</strong> 套餐</p>
              
              <div class="payment-notice">
                <div class="notice-title">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12" y2="16"></line>
                  </svg>
                  <span>重要提醒</span>
                </div>
                <ul class="notice-list">
                  <li>请务必填写正确的邮箱地址，邮箱要与此软件注册邮箱一致。</li>
                  <li>支付完成后，会员将在 5 分钟内自动到账。</li>
                  <li>如遇问题，请发送邮件至：<a href="mailto:smtoffice@yeah.net">smtoffice@yeah.net</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(paymentModal);

  // 添加付款模态框的样式
  if (!document.querySelector('#payment-modal-styles')) {
    const style = document.createElement('style');
    style.id = 'payment-modal-styles';
    style.textContent = `
      .payment-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 10001;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .payment-modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      
      .payment-modal-container {
        background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.98));
        border-radius: 20px;
        padding: 0;
        width: 95%;
        max-width: 1200px;
        max-height: 90vh;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.06);
        backdrop-filter: blur(20px);
        transform: scale(0.9);
        transition: transform 0.3s ease;
        overflow: hidden;
      }
      
      .payment-modal-overlay.active .payment-modal-container {
        transform: scale(1);
      }
      
      .payment-modal-header {
        padding: 20px 24px 16px;
        border-bottom: 1px solid #f0f0f0;
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 12px;
        align-items: center;
        background: rgba(255,255,255,0.95);
        color: #333;
      }

      .payment-title-group h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .payment-subtitle {
        margin-top: 4px;
        font-size: 13px;
        color: #666;
      }

      .price-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 9999px;
        background: rgba(77, 166, 255, 0.12);
        color: #4da6ff;
        font-weight: 600;
        font-size: 13px;
        border: 1px solid rgba(77,166,255,0.22);
      }
      
      .payment-modal-close {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        padding: 4px;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }
      
      .payment-modal-close:hover {
        background: #f5f5f5;
        color: #666;
      }
      
      .payment-modal-body {
        padding: 20px 24px 24px;
      }
      
      .payment-content {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 24px;
        align-items: start;
      }
      
      .payment-left {
        flex: 0 0 auto;
      }
      
      .qr-panel {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 16px;
      }

      .qr-code-container {
        text-align: center;
      }
      
      .qr-code {
        width: 240px;
        height: 240px;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        padding: 8px;
        background: white;
      }
      
      .qr-code-label {
        margin: 12px 0 0;
        font-size: 14px;
        color: #666;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .qr-logo {
        width: 16px;
        height: 16px;
        display: inline-block;
        border-radius: 3px;
      }
      
      .payment-right {
        flex: 1;
      }
      
      .payment-info-title {
        margin: 0 0 12px;
        font-size: 16px;
        color: #333;
        font-weight: 600;
      }
      
      .plan-selection {
        margin: 0 0 16px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.65);
        backdrop-filter: saturate(140%) blur(6px);
        border-radius: 12px;
        border: 1px solid rgba(77, 166, 255, 0.18);
        font-size: 14px;
        color: #333;
      }
      
      .payment-notice {
        margin: 16px 0 0;
        padding: 14px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: saturate(140%) blur(6px);
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.06);
      }
      
      .payment-notice p {
        margin: 8px 0;
        font-size: 14px;
        color: #333;
        line-height: 1.5;
      }

      .notice-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #666;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .notice-title svg { color: #7aaeff; }

      .notice-list {
        margin: 0;
        padding-left: 18px;
        color: #555;
        font-size: 14px;
        line-height: 1.6;
      }
      
      .payment-notice p:first-child {
        font-weight: 600;
        margin-bottom: 12px;
      }
      
      .payment-notice a {
        color: #4da6ff;
        text-decoration: none;
      }
      
      .payment-notice a:hover {
        text-decoration: underline;
      }
      
      /* 删除邮箱输入区样式：付款界面不再需要填写邮箱 */
      
      @media (max-width: 860px) {
        .payment-modal-container {
          width: 95%;
          margin: 20px;
        }
        
        .payment-content {
          grid-template-columns: 1fr;
          gap: 16px;
        }
        
        .payment-left {
          order: 2;
        }
        
        .payment-right {
          order: 1;
        }
      }
    `;
    document.head.appendChild(style);
  }
}

// 扩容云空间按钮事件监听器
document.addEventListener('DOMContentLoaded', function() {
  const expandStorageBtn = document.getElementById('expandStorageBtn');
  if (expandStorageBtn) {
    expandStorageBtn.addEventListener('click', function() {
      // 直接打开完整的升级页面
      openUpgradePage();
    });
  }
});

function showUpgradeModal() {
  // 移除已存在的模态框
  const existingModal = document.querySelector('.upgrade-modal');
  if (existingModal) {
    existingModal.remove();
  }

  // 移除已存在的样式
  const existingStyle = document.querySelector('#upgrade-modal-styles');
  if (existingStyle) {
    existingStyle.remove();
  }

  const modal = document.createElement('div');
  modal.className = 'upgrade-modal';
  modal.innerHTML = `
    <div class="upgrade-modal-content">
       <div class="upgrade-modal-header">
         <h3>
           <svg style="width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
             <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/>
           </svg>
           扩容云空间
         </h3>
         <button class="close-modal-btn">&times;</button>
       </div>
       <div class="upgrade-modal-body">
         <div class="current-storage">
           <span class="storage-label">当前存储</span>
           <span class="storage-value">226 B / 2 MB</span>
         </div>
         <div class="upgrade-benefits">
           <h4>升级到 Pro 版本享受：</h4>
           <ul>
             <li>
               <svg style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                 <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
               </svg>
               无限云存储空间
             </li>
             <li>
               <svg style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                 <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 9.74C4.46 10.97 4 11.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
               </svg>
               多设备同步
             </li>
             <li>
               <svg style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                 <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4v2h8v-2h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H4V4h16v12z"/>
                 <circle cx="12" cy="10" r="2"/>
               </svg>
               AI 智能助手
             </li>
             <li>
               <svg style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                 <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
               </svg>
               高级数据分析
             </li>
             <li>
               <svg style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                 <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V11.5C14.8,12.6 14.4,13.5 13.3,13.5H10.7C9.6,13.5 9.2,12.6 9.2,11.5V10C9.2,8.6 10.6,7 12,7Z"/>
               </svg>
               优先技术支持
             </li>
           </ul>
         </div>
        <div class="upgrade-actions">
          <button class="upgrade-btn primary" onclick="handleUpgrade('monthly')">
            立即升级 Pro
          </button>
          <button class="upgrade-btn secondary" onclick="closeUpgradeModal()">
            稍后再说
          </button>
        </div>
      </div>
    </div>
  `;

  // 添加模态框样式
  const style = document.createElement('style');
  style.id = 'upgrade-modal-styles';
  style.textContent = `
     .upgrade-modal {
       position: absolute;
       top: 0;
       left: 0;
       width: 100%;
       height: 100%;
       background: rgba(0, 0, 0, 0.6);
       backdrop-filter: blur(8px);
       display: flex;
       align-items: center;
       justify-content: center;
       z-index: 1000;
       animation: modalFadeIn 0.3s ease;
       border-radius: 0;
     }

    .upgrade-modal-content {
      background: white;
      border-radius: 16px;
      padding: 0;
      max-width: 450px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      animation: modalSlideUp 0.3s ease;
    }

    .upgrade-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .upgrade-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
    }

    .close-modal-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #999;
      padding: 4px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .close-modal-btn:hover {
      background: #f5f5f5;
      color: #666;
    }

    .upgrade-modal-body {
      padding: 20px 24px 24px;
    }

    .current-storage {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: rgba(77, 166, 255, 0.08);
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .storage-label {
      font-weight: 500;
      color: #4da6ff;
      font-size: 14px;
    }

    .storage-value {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .upgrade-benefits h4 {
      margin: 0 0 14px 0;
      font-size: 15px;
      font-weight: 600;
      color: #333;
    }

    .upgrade-benefits ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .upgrade-benefits li {
      padding: 6px 0;
      color: #555;
      font-size: 13px;
      display: flex;
      align-items: center;
    }

    .upgrade-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .upgrade-btn {
      flex: 1;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .upgrade-btn.primary {
      background: #4da6ff;
      color: white;
    }

    .upgrade-btn.primary:hover {
      background: #3399ff;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(77, 166, 255, 0.3);
    }

    .upgrade-btn.secondary {
      background: #f8f9fa;
      color: #666;
      border: 1px solid #e9ecef;
    }

    .upgrade-btn.secondary:hover {
      background: #e9ecef;
      color: #333;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes modalSlideUp {
      from { 
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes modalFadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  `;

  document.head.appendChild(style);
  document.body.appendChild(modal);

  // 关闭按钮事件
  modal.querySelector('.close-modal-btn').addEventListener('click', closeUpgradeModal);
  
  // 点击背景关闭
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeUpgradeModal();
    }
  });
}

function closeUpgradeModal() {
  const modal = document.querySelector('.upgrade-modal');
  if (modal) {
    modal.style.animation = 'modalFadeOut 0.3s ease';
    setTimeout(() => {
      modal.remove();
      // 清理样式
      const style = document.querySelector('#upgrade-modal-styles');
      if (style) {
        style.remove();
      }
    }, 300);
  }
}
</script>

<!-- Spark API integration -->
<script src="smt-ai-api.js"></script>
<script src="init-smt.js"></script>
</body>
</html>
